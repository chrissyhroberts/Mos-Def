<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.556">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Design, Optimisation, Validation, and Analysis Framework for Multiplex Bead‑Based Biomarker Assays - 17&nbsp; Data Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./appendix.html" rel="next">
<link href="./Specimen_Testing.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Analysis_02.html"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Data Analysis</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Design, Optimisation, Validation, and Analysis Framework for Multiplex Bead‑Based Biomarker Assays</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fever.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">About this exemplar assay</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bloodspots.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Dried Blood Spots</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Marker_List.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">List of Markers</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Buffers_and_Reagents.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Buffers &amp; Reagents</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Capture_Antibody_Prep.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Capture Antibody Preparation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Bead_Coupling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Bead Coupling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Coupling_Confirmation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Coupling Confirmation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Detection_Antibody_Prep.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Detection Antibody Prep</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./antigens.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Antigens</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./antibody_pairs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Antibody pair screening</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Cross_Reactivity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Cross-reactivity Testing</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Standards_Prep.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Standard curves</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Magpix_Protocol.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">MagPix Protocol</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Coefficients_of_Variation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Coefficients of Variation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Specimen_Testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Specimen Testing</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Analysis_02.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Funding &amp; Declarations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CRediT.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">CRediT Framework</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#functions-and-tutorial-for-working-with-multiplexed-immunoassay-data" id="toc-functions-and-tutorial-for-working-with-multiplexed-immunoassay-data" class="nav-link active" data-scroll-target="#functions-and-tutorial-for-working-with-multiplexed-immunoassay-data"><span class="header-section-number">17.1</span> Functions and tutorial for working with multiplexed immunoassay data</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"><span class="header-section-number">17.2</span> Introduction</a></li>
  <li><a href="#libraries" id="toc-libraries" class="nav-link" data-scroll-target="#libraries"><span class="header-section-number">17.3</span> Libraries</a></li>
  <li><a href="#define-functions" id="toc-define-functions" class="nav-link" data-scroll-target="#define-functions"><span class="header-section-number">17.4</span> Define Functions</a>
  <ul class="collapse">
  <li><a href="#function-to-read-and-analyse-luminex-plates" id="toc-function-to-read-and-analyse-luminex-plates" class="nav-link" data-scroll-target="#function-to-read-and-analyse-luminex-plates"><span class="header-section-number">17.4.1</span> Function to Read and analyse Luminex Plates</a></li>
  <li><a href="#function-to-draw-roc-chart-in-ggplot" id="toc-function-to-draw-roc-chart-in-ggplot" class="nav-link" data-scroll-target="#function-to-draw-roc-chart-in-ggplot"><span class="header-section-number">17.4.2</span> Function to draw ROC chart in ggplot</a></li>
  <li><a href="#function-to-generate-roc-tables-for-multiple-biomarkers" id="toc-function-to-generate-roc-tables-for-multiple-biomarkers" class="nav-link" data-scroll-target="#function-to-generate-roc-tables-for-multiple-biomarkers"><span class="header-section-number">17.4.3</span> Function to generate ROC tables for multiple biomarkers</a></li>
  <li><a href="#function-to-generate-a-roc-curve-conditioned-on-a-variable" id="toc-function-to-generate-a-roc-curve-conditioned-on-a-variable" class="nav-link" data-scroll-target="#function-to-generate-a-roc-curve-conditioned-on-a-variable"><span class="header-section-number">17.4.4</span> Function to generate a ROC curve conditioned on a variable</a></li>
  <li><a href="#function-to-estimate-luminex-standard-curve-and-predict-concentrations-for-all-plates-and-assays" id="toc-function-to-estimate-luminex-standard-curve-and-predict-concentrations-for-all-plates-and-assays" class="nav-link" data-scroll-target="#function-to-estimate-luminex-standard-curve-and-predict-concentrations-for-all-plates-and-assays"><span class="header-section-number">17.4.5</span> Function to Estimate Luminex Standard Curve and Predict Concentrations for All Plates and Assays</a></li>
  <li><a href="#function-to-apply-standard-curve-estimation-across-all-plates-and-assays" id="toc-function-to-apply-standard-curve-estimation-across-all-plates-and-assays" class="nav-link" data-scroll-target="#function-to-apply-standard-curve-estimation-across-all-plates-and-assays"><span class="header-section-number">17.4.6</span> Function to Apply Standard Curve Estimation Across All Plates and Assays</a></li>
  <li><a href="#function-to-plot-positive-predictive-values" id="toc-function-to-plot-positive-predictive-values" class="nav-link" data-scroll-target="#function-to-plot-positive-predictive-values"><span class="header-section-number">17.4.7</span> Function to plot Positive Predictive Values</a></li>
  <li><a href="#function-to-compute-confusion-matrix-statistics" id="toc-function-to-compute-confusion-matrix-statistics" class="nav-link" data-scroll-target="#function-to-compute-confusion-matrix-statistics"><span class="header-section-number">17.4.8</span> Function to compute confusion matrix statistics</a></li>
  </ul></li>
  <li><a href="#plate-setup-and-data-reading" id="toc-plate-setup-and-data-reading" class="nav-link" data-scroll-target="#plate-setup-and-data-reading"><span class="header-section-number">17.5</span> Plate Setup and data reading</a>
  <ul class="collapse">
  <li><a href="#setup-plate-data" id="toc-setup-plate-data" class="nav-link" data-scroll-target="#setup-plate-data"><span class="header-section-number">17.5.1</span> Setup Plate data</a></li>
  <li><a href="#standards" id="toc-standards" class="nav-link" data-scroll-target="#standards"><span class="header-section-number">17.5.2</span> Standards</a></li>
  <li><a href="#plate-level-mfi-distribution-by-assay" id="toc-plate-level-mfi-distribution-by-assay" class="nav-link" data-scroll-target="#plate-level-mfi-distribution-by-assay"><span class="header-section-number">17.5.3</span> Plate-Level MFI Distribution by Assay</a></li>
  <li><a href="#application-of-standard-curve-to-convert-mfi-to-concentration" id="toc-application-of-standard-curve-to-convert-mfi-to-concentration" class="nav-link" data-scroll-target="#application-of-standard-curve-to-convert-mfi-to-concentration"><span class="header-section-number">17.5.4</span> Application of Standard Curve to Convert MFI to Concentration</a></li>
  <li><a href="#visualisation-of-fitted-concentration-estimates-across-plates" id="toc-visualisation-of-fitted-concentration-estimates-across-plates" class="nav-link" data-scroll-target="#visualisation-of-fitted-concentration-estimates-across-plates"><span class="header-section-number">17.5.5</span> Visualisation of Fitted Concentration Estimates Across Plates</a></li>
  <li><a href="#remove-standards-before-further-analysis" id="toc-remove-standards-before-further-analysis" class="nav-link" data-scroll-target="#remove-standards-before-further-analysis"><span class="header-section-number">17.5.6</span> Remove Standards Before Further Analysis</a></li>
  <li><a href="#pivot-data-to-wide-format" id="toc-pivot-data-to-wide-format" class="nav-link" data-scroll-target="#pivot-data-to-wide-format"><span class="header-section-number">17.5.7</span> Pivot Data to wide format</a></li>
  <li><a href="#normalise-scores-for-modelling-purposes" id="toc-normalise-scores-for-modelling-purposes" class="nav-link" data-scroll-target="#normalise-scores-for-modelling-purposes"><span class="header-section-number">17.5.8</span> Normalise scores for modelling purposes</a></li>
  </ul></li>
  <li><a href="#create-some-dummy-clinical-data-for-analysis" id="toc-create-some-dummy-clinical-data-for-analysis" class="nav-link" data-scroll-target="#create-some-dummy-clinical-data-for-analysis"><span class="header-section-number">17.6</span> Create some dummy clinical data for analysis</a></li>
  <li><a href="#example-analyses" id="toc-example-analyses" class="nav-link" data-scroll-target="#example-analyses"><span class="header-section-number">17.7</span> Example Analyses</a>
  <ul class="collapse">
  <li><a href="#roc-analysis" id="toc-roc-analysis" class="nav-link" data-scroll-target="#roc-analysis"><span class="header-section-number">17.7.1</span> ROC Analysis</a></li>
  <li><a href="#roc-analysis-of-more-than-one-marker-using-patchwork" id="toc-roc-analysis-of-more-than-one-marker-using-patchwork" class="nav-link" data-scroll-target="#roc-analysis-of-more-than-one-marker-using-patchwork"><span class="header-section-number">17.7.2</span> ROC Analysis of more than one marker using patchwork</a></li>
  <li><a href="#roc-table" id="toc-roc-table" class="nav-link" data-scroll-target="#roc-table"><span class="header-section-number">17.7.3</span> ROC Table</a></li>
  <li><a href="#roc-analysis-conditioned-by-another-variable" id="toc-roc-analysis-conditioned-by-another-variable" class="nav-link" data-scroll-target="#roc-analysis-conditioned-by-another-variable"><span class="header-section-number">17.7.4</span> ROC analysis, conditioned by another variable</a></li>
  <li><a href="#metamodel" id="toc-metamodel" class="nav-link" data-scroll-target="#metamodel"><span class="header-section-number">17.7.5</span> Metamodel</a></li>
  <li><a href="#interaction-model-biomarkers-hiv-status" id="toc-interaction-model-biomarkers-hiv-status" class="nav-link" data-scroll-target="#interaction-model-biomarkers-hiv-status"><span class="header-section-number">17.7.6</span> <strong>Interaction Model: Biomarkers × HIV Status</strong></a></li>
  <li><a href="#ppvnpv-charts" id="toc-ppvnpv-charts" class="nav-link" data-scroll-target="#ppvnpv-charts"><span class="header-section-number">17.7.7</span> PPV/NPV charts</a></li>
  <li><a href="#calculate-confusion-matrix-based-on-a-chosen-threshold" id="toc-calculate-confusion-matrix-based-on-a-chosen-threshold" class="nav-link" data-scroll-target="#calculate-confusion-matrix-based-on-a-chosen-threshold"><span class="header-section-number">17.7.8</span> Calculate confusion Matrix based on a chosen threshold</a></li>
  </ul></li>
  <li><a href="#identifying-clusters-via-principal-components-analysis" id="toc-identifying-clusters-via-principal-components-analysis" class="nav-link" data-scroll-target="#identifying-clusters-via-principal-components-analysis"><span class="header-section-number">17.8</span> Identifying clusters via Principal Components Analysis</a>
  <ul class="collapse">
  <li><a href="#linear-regression-to-identify-prognostic-principal-components" id="toc-linear-regression-to-identify-prognostic-principal-components" class="nav-link" data-scroll-target="#linear-regression-to-identify-prognostic-principal-components"><span class="header-section-number">17.8.1</span> Linear Regression to identify prognostic Principal Components</a></li>
  <li><a href="#interpreting-pcs-with-loadings-plots" id="toc-interpreting-pcs-with-loadings-plots" class="nav-link" data-scroll-target="#interpreting-pcs-with-loadings-plots"><span class="header-section-number">17.8.2</span> Interpreting PCs with loadings plots</a></li>
  <li><a href="#roc-analysis-of-pc-associations-with-outcomes" id="toc-roc-analysis-of-pc-associations-with-outcomes" class="nav-link" data-scroll-target="#roc-analysis-of-pc-associations-with-outcomes"><span class="header-section-number">17.8.3</span> ROC analysis of PC associations with outcomes</a></li>
  <li><a href="#mahalanobis-distance-for-outlier-detection-or-risk-scoring" id="toc-mahalanobis-distance-for-outlier-detection-or-risk-scoring" class="nav-link" data-scroll-target="#mahalanobis-distance-for-outlier-detection-or-risk-scoring"><span class="header-section-number">17.8.4</span> <strong>Mahalanobis Distance for Outlier Detection or Risk Scoring</strong></a></li>
  </ul></li>
  <li><a href="#marker-importance-and-selection" id="toc-marker-importance-and-selection" class="nav-link" data-scroll-target="#marker-importance-and-selection"><span class="header-section-number">17.9</span> Marker Importance and Selection</a>
  <ul class="collapse">
  <li><a href="#variable-selection" id="toc-variable-selection" class="nav-link" data-scroll-target="#variable-selection"><span class="header-section-number">17.9.1</span> Variable Selection</a></li>
  <li><a href="#approaches-used-for-variable-selection" id="toc-approaches-used-for-variable-selection" class="nav-link" data-scroll-target="#approaches-used-for-variable-selection"><span class="header-section-number">17.9.2</span> Approaches Used for variable selection</a></li>
  <li><a href="#enhancing-clinical-relevance-adding-demographic-and-clinical-variables" id="toc-enhancing-clinical-relevance-adding-demographic-and-clinical-variables" class="nav-link" data-scroll-target="#enhancing-clinical-relevance-adding-demographic-and-clinical-variables"><span class="header-section-number">17.9.3</span> Enhancing Clinical Relevance: Adding Demographic and Clinical Variables</a></li>
  <li><a href="#boruta-analysis" id="toc-boruta-analysis" class="nav-link" data-scroll-target="#boruta-analysis"><span class="header-section-number">17.9.4</span> Boruta Analysis</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">18</span> Summary</a>
  <ul class="collapse">
  <li><a href="#final-reflection" id="toc-final-reflection" class="nav-link" data-scroll-target="#final-reflection"><span class="header-section-number">18.0.1</span> Final Reflection</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Data Analysis</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="functions-and-tutorial-for-working-with-multiplexed-immunoassay-data" class="level2" data-number="17.1">
<h2 data-number="17.1" class="anchored" data-anchor-id="functions-and-tutorial-for-working-with-multiplexed-immunoassay-data"><span class="header-section-number">17.1</span> Functions and tutorial for working with multiplexed immunoassay data</h2>
</section>
<section id="introduction" class="level2" data-number="17.2">
<h2 data-number="17.2" class="anchored" data-anchor-id="introduction"><span class="header-section-number">17.2</span> Introduction</h2>
<p>This script processes and analyses Luminex immunoassay data to evaluate the predictive performance of multiple biomarkers. It begins with a quality-assured workflow that includes standardisation, background correction, and intra-/inter-plate normalisation. Raw MFI (median fluorescence intensity) values are log-transformed and fitted to 4-parameter logistic (4PL) models to derive concentration estimates from standard curves. The script implements automated checks for model convergence and excludes poor-quality fits where needed.</p>
<p>A suite of custom functions supports downstream analysis, including ROC curve generation (overall and subgroup-conditioned), PPV/NPV curve plotting, and confusion matrix-based statistics. The script outputs both tabular summaries and visual diagnostics to support biomarker evaluation, predictive threshold selection, and rule-based classification. It also includes exploratory and multivariate approaches such as feature selection, dimensionality reduction, and metamodel development.</p>
<p><strong>Major analysis components:</strong></p>
<ul>
<li><p><strong>Standard curve fitting using 4-parameter logistic models (4PL)</strong><br>
Converts raw MFI values to estimated concentrations for each biomarker on each plate.</p></li>
<li><p><strong>Quality assurance checks and log transformation</strong><br>
Removes background standards (e.g., S8), filters invalid values, and applies log10 transformation to MFI and concentration data.</p></li>
<li><p><strong>Normalisation of concentration values (z-scores)</strong><br>
Standardises biomarker concentrations within each analyte using z-transformation to allow plate-agnostic comparisons.</p></li>
<li><p><strong>Receiver Operating Characteristic (ROC) analysis</strong><br>
Assesses discriminatory ability of individual biomarkers via AUC, sensitivity, specificity, and confidence intervals.</p></li>
<li><p><strong>Stratified ROC plotting</strong><br>
Visualises ROC performance within subgroups (e.g., by viral-status or demographic category etc) to evaluate consistency.</p></li>
<li><p><strong>Predictive value curve plotting (PPV/NPV)</strong><br>
Examines clinical utility of biomarkers across decision thresholds using derived PPV and NPV.</p></li>
<li><p><strong>Confusion matrix analysis at arbitrary thresholds</strong><br>
Quantifies classification accuracy, sensitivity, specificity, PPV, NPV, and more based on rule-based cutoffs.</p></li>
<li><p><strong>Adjusted PPV estimation</strong><br>
Models a counterfactual scenario for high-risk inpatients using outpatient mortality to adjust apparent predictive value.</p></li>
<li><p><strong>Variable selection using Boruta</strong><br>
Ranks and selects relevant biomarkers using a random forest wrapper that tests importance against shadow features.</p></li>
<li><p><strong>Recursive Feature Elimination (RFE)</strong><br>
Iteratively removes less informative variables to identify minimal predictive sets optimised for classification.</p></li>
<li><p><strong>Principal Component Analysis (PCA)</strong><br>
Performs unsupervised dimensionality reduction to summarise structure in the data and explore separation of outcome groups.</p></li>
<li><p><strong>Confirmatory Generalised Linear Models (GLMs)</strong><br>
Tests combinations of selected biomarkers in multivariable logistic regression to evaluate adjusted predictive power.</p></li>
</ul>
<p><strong>Key functions:</strong></p>
<ul>
<li><p><code>luminex.process.data()</code>: Imports raw Luminex CSV output, performs reshaping, and applies background correction and metadata integration.</p></li>
<li><p><code>luminex_standard_curve_estimator()</code>: Fits 4PL curves on each plate-assay pair; log-transforms MFI and concentration values; checks model fit.</p></li>
<li><p><code>apply_luminex_standard_curve()</code>: Iterates over all unique plate-assay combinations to estimate specimen concentrations.</p></li>
<li><p><code>ROCit_plot()</code>: Computes and plots ROC curves with bootstrapped AUC confidence intervals.</p></li>
<li><p><code>ROCit_plot_conditioned()</code>: Generates ROC curves stratified by subgroup (e.g.&nbsp;HIV Positive Vs HIV Negative).</p></li>
<li><p><code>generate_roc_tables()</code>: Produces AUC summaries across multiple biomarkers in tabular format.</p></li>
<li><p><code>plot_ppv()</code>: Plots PPV and NPV curves across thresholds to support classifier cut-off selection.</p></li>
<li><p><code>compute_conf_matrix_stats()</code>: Calculates classification metrics (e.g.&nbsp;sensitivity, specificity, PPV, NPV, accuracy) from binary rules.</p></li>
<li><p><code>compute_adjusted_biomarker_stats()</code>: Computes subgroup-specific performance metrics and adjusted PPV accounting for admission bias.</p></li>
</ul>
<hr>
</section>
<section id="libraries" class="level2" data-number="17.3">
<h2 data-number="17.3" class="anchored" data-anchor-id="libraries"><span class="header-section-number">17.3</span> Libraries</h2>
<p>Load the libraries used in this analysis and set a seed so that this is fully reproducible.</p>
</section>
<section id="define-functions" class="level2" data-number="17.4">
<h2 data-number="17.4" class="anchored" data-anchor-id="define-functions"><span class="header-section-number">17.4</span> Define Functions</h2>
<section id="function-to-read-and-analyse-luminex-plates" class="level3" data-number="17.4.1">
<h3 data-number="17.4.1" class="anchored" data-anchor-id="function-to-read-and-analyse-luminex-plates"><span class="header-section-number">17.4.1</span> Function to Read and analyse Luminex Plates</h3>
<p>This function imports and tidies raw Luminex assay data from one or more specified <code>.csv</code> file. It extracts and reshapes MFI and bead count data, assigns unique identifiers, filters out poor-quality measurements, and merges the assay data with known standard concentrations. The output is a clean, annotated dataframe ready for downstream quantification and analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to process raw Luminex assay data from a given file and return a tidy dataframe</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>luminex.process.data <span class="ot">&lt;-</span> <span class="cf">function</span>(file, <span class="at">standards.file =</span> <span class="st">"data/MOSDEF_Standard_Concs.csv"</span>) {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">####### Load and clean Luminex data file #######</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(file, <span class="at">skip =</span> <span class="dv">41</span>, <span class="at">na =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"NaN"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setNames</span>(<span class="fu">tolower</span>(<span class="fu">gsub</span>(<span class="st">"-"</span>, <span class="st">"_"</span>, <span class="fu">names</span>(.)))) <span class="sc">%&gt;%</span>    <span class="co"># Convert column names to lowercase and replace hyphens with underscores</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sample =</span> <span class="fu">fct_na_value_to_level</span>(sample)) <span class="sc">%&gt;%</span> <span class="co"># Convert NA levels in 'sample' column to an explicit factor level</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select_if</span>(<span class="sc">!</span><span class="fu">names</span>(.) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'...17'</span>, <span class="st">'location'</span>, <span class="st">'total events'</span>))  <span class="co"># Drop unused or noisy columns</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure CRP column exists even if missing</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="st">'crp'</span> <span class="sc">%in%</span> <span class="fu">names</span>(df)) df<span class="sc">$</span>crp <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">####### Assign unique IDs to samples #######</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  randomid <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1</span>) {</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generates a random alphanumeric ID of the form 'ABCDE1234Z'</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">do.call</span>(paste0, <span class="fu">replicate</span>(<span class="dv">5</span>, <span class="fu">sample</span>(LETTERS, n, <span class="cn">TRUE</span>), <span class="cn">FALSE</span>))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(a, <span class="fu">sprintf</span>(<span class="st">"%04d"</span>, <span class="fu">sample</span>(<span class="dv">9999</span>, n, <span class="cn">TRUE</span>)), <span class="fu">sample</span>(LETTERS, n, <span class="cn">TRUE</span>))</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">####### Extract and reshape Net MFI values #######</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  MFI.medians <span class="ot">&lt;-</span> df[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">which</span>(<span class="fu">str_detect</span>(<span class="at">string =</span> df<span class="sc">$</span>sample, <span class="at">pattern =</span> <span class="st">"Net MFI"</span>))[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">1</span>), ] <span class="sc">%&gt;%</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">test.id =</span> <span class="fu">randomid</span>(<span class="at">n =</span> <span class="fu">nrow</span>(.))) <span class="sc">%&gt;%</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">14</span>, <span class="at">names_to =</span> <span class="st">"assay"</span>, <span class="at">values_to =</span> <span class="st">"mfi"</span>)  <span class="co"># Reshape to long format</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">####### Extract and reshape bead count values #######</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  MFI.counts <span class="ot">&lt;-</span> df[</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">which</span>(<span class="fu">str_detect</span>(<span class="at">string =</span> df<span class="sc">$</span>sample, <span class="at">pattern =</span> <span class="st">"Count"</span>))[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">2</span>)<span class="sc">:</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">which</span>(<span class="fu">str_detect</span>(<span class="at">string =</span> df<span class="sc">$</span>sample, <span class="at">pattern =</span> <span class="st">"Avg Net MFI"</span>))[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  ] <span class="sc">%&gt;%</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">14</span>, <span class="at">names_to =</span> <span class="st">"assay"</span>, <span class="at">values_to =</span> <span class="st">"bead.count"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">test.id =</span> MFI.medians<span class="sc">$</span>test.id)  <span class="co"># Align by test ID</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="do">####### Merge MFI and bead count data, clean and filter #######</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">full_join</span>(MFI.medians, MFI.counts) <span class="sc">%&gt;%</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">mfi =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(mfi)),                 <span class="co"># Ensure MFI is numeric</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">bead.count =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(bead.count))    <span class="co"># Ensure bead count is numeric</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>      sample <span class="sc">!=</span> <span class="st">"(Missing)"</span>,      <span class="co"># Remove missing samples</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>      bead.count <span class="sc">&gt;</span> <span class="dv">15</span>,            <span class="co"># Minimum quality threshold for bead count</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(mfi)                 <span class="co"># Remove rows with missing MFI values</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  <span class="do">####### Read and tidy standard concentrations #######</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  standards <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(standards.file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> S1<span class="sc">:</span>S8, <span class="at">names_to =</span> <span class="st">"sample"</span>, <span class="at">values_to =</span> <span class="st">"conc"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">conc =</span> <span class="fu">as.numeric</span>(</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>        <span class="fu">case_when</span>(</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>          unit <span class="sc">==</span> <span class="st">'ng_ml'</span> <span class="sc">~</span> conc <span class="sc">*</span> <span class="dv">1000</span>,  <span class="co"># Convert concentration to pg/mL if needed</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>          <span class="cn">TRUE</span> <span class="sc">~</span> conc</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">assay =</span> <span class="fu">tolower</span>(assay),                         <span class="co"># Normalise assay names</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">assay =</span> <span class="fu">gsub</span>(<span class="at">x =</span> assay, <span class="at">pattern =</span> <span class="st">"-"</span>, <span class="at">replacement =</span> <span class="st">"_"</span>)  <span class="co"># Standardise naming</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>unit) <span class="sc">%&gt;%</span>         <span class="co"># Drop unit column after conversion</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">class =</span> <span class="st">"standard"</span>)       <span class="co"># Tag as standard samples</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>  <span class="do">####### Merge standards with assay data #######</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">left_join</span>(df, standards)           <span class="co"># Add known concentrations to matching samples</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>class[<span class="fu">is.na</span>(df<span class="sc">$</span>class)] <span class="ot">&lt;-</span> <span class="st">"specimen"</span>  <span class="co"># Tag unmatched rows as experimental specimens</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>  <span class="do">####### Derive plate name from filename #######</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>  plate <span class="ot">&lt;-</span> <span class="fu">str_replace</span>(<span class="at">string =</span> file, <span class="at">pattern =</span> <span class="st">"data_in//"</span>, <span class="at">replacement =</span> <span class="st">""</span>)  <span class="co"># Clean path</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  plate <span class="ot">&lt;-</span> <span class="fu">str_replace</span>(<span class="at">string =</span> plate, <span class="at">pattern =</span> <span class="st">".csv"</span>, <span class="at">replacement =</span> <span class="st">""</span>)      <span class="co"># Remove extension</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>plate <span class="ot">&lt;-</span> plate                        <span class="co"># Store plate label in output</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)  <span class="co"># Return tidy, annotated dataset</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="function-to-draw-roc-chart-in-ggplot" class="level3" data-number="17.4.2">
<h3 data-number="17.4.2" class="anchored" data-anchor-id="function-to-draw-roc-chart-in-ggplot"><span class="header-section-number">17.4.2</span> Function to draw ROC chart in ggplot</h3>
<p>This function generates a receiver operating characteristic (ROC) curve from a given dataset, comparing a continuous biomarker score to a binary outcome (e.g.&nbsp;alive vs dead). It supports output as a ggplot2 figure or a tabulated set of performance metrics, and includes optional colour and style customisation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">####### Function to draw ROC chart in ggplot #######</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>ROCit_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(data, score_col, class_col, <span class="at">failcode =</span> <span class="cn">NULL</span>, <span class="at">title =</span> <span class="st">"ROC Curve"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">negate_score =</span> <span class="cn">FALSE</span>, <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">color =</span> <span class="cn">NULL</span>, <span class="at">output =</span> <span class="st">"chart"</span>) {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load required libraries</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(ggplot2)       <span class="co"># Plotting system</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dplyr)         <span class="co"># Data manipulation</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tibble)        <span class="co"># Tidy tibble data frames</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(RColorBrewer)  <span class="co"># Color palettes</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(ROCit)         <span class="co"># ROC curve and AUC computation</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use a colorblind-friendly palette if no color is provided</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(color)) {</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    colors <span class="ot">&lt;-</span> <span class="fu">brewer.pal</span>(<span class="at">n =</span> <span class="dv">8</span>, <span class="st">"Dark2"</span>)              <span class="co"># Load Dark2 palette</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    curve_color <span class="ot">&lt;-</span> <span class="cf">if</span> (negate_score) colors[<span class="dv">2</span>] <span class="cf">else</span> colors[<span class="dv">1</span>]  <span class="co"># Use different colors depending on score polarity</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    curve_color <span class="ot">&lt;-</span> color  <span class="co"># Use custom user-defined color</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine which class is considered the "positive" (i.e. fail) class</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  class_levels <span class="ot">&lt;-</span> <span class="fu">levels</span>(<span class="fu">factor</span>(data[[class_col]]))  <span class="co"># Get levels of classification variable</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(failcode) <span class="sc">&amp;&amp;</span> failcode <span class="sc">%in%</span> class_levels) {</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    pos_class <span class="ot">&lt;-</span> failcode                                <span class="co"># Use user-defined failcode</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    pos_class <span class="ot">&lt;-</span> class_levels[<span class="dv">2</span>]                <span class="co"># Default to second level if not specified</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert class column to binary: 1 = positive class, 0 = negative</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>outcome_binary <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[class_col]] <span class="sc">==</span> pos_class)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Conditionally negate scores (some metrics are inversely related to outcome)</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  score_values <span class="ot">&lt;-</span> <span class="cf">if</span> (negate_score) <span class="sc">-</span>data[[score_col]] <span class="cf">else</span> data[[score_col]]</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute ROC curve object</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  rocit_obj <span class="ot">&lt;-</span> <span class="fu">rocit</span>(<span class="at">score =</span> score_values, <span class="at">class =</span> data<span class="sc">$</span>outcome_binary)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate confidence intervals for AUC using bootstrapping</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  auc_ci <span class="ot">&lt;-</span> <span class="fu">ciAUC</span>(rocit_obj, <span class="at">method =</span> <span class="st">"bootstrap"</span>, <span class="at">boot.n =</span> <span class="dv">1000</span>)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract AUC and its confidence intervals</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  auc_value <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(rocit_obj<span class="sc">$</span>AUC)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  auc_lower <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(auc_ci<span class="sc">$</span>lower)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  auc_upper <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(auc_ci<span class="sc">$</span>upper)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count number of positive and negative samples</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  n_neg <span class="ot">&lt;-</span> <span class="fu">sum</span>(data[[class_col]] <span class="sc">!=</span> pos_class, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  n_pos <span class="ot">&lt;-</span> <span class="fu">sum</span>(data[[class_col]] <span class="sc">==</span> pos_class, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate AUC label for display</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>  auc_label <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.na</span>(auc_lower) <span class="sc">|</span> <span class="fu">is.na</span>(auc_upper)) {</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">"AUC = "</span>, <span class="fu">round</span>(auc_value, <span class="dv">2</span>), <span class="st">" (CI: N/A)"</span>)</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">"AUC = "</span>, <span class="fu">round</span>(auc_value, <span class="dv">2</span>), <span class="st">" ("</span>, <span class="fu">round</span>(auc_lower, <span class="dv">2</span>), <span class="st">"–"</span>, <span class="fu">round</span>(auc_upper, <span class="dv">2</span>), <span class="st">")"</span>)</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optionally return a summary table instead of a plot</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (output <span class="sc">==</span> <span class="st">"table"</span>) {</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    summary_table <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">Assay =</span> score_col,</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">Outcome =</span> class_col,</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">Failcode =</span> pos_class,</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">AUC =</span> <span class="fu">round</span>(auc_value, <span class="dv">2</span>),</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">CI_Lower =</span> <span class="fu">round</span>(auc_lower, <span class="dv">2</span>),</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">CI_Upper =</span> <span class="fu">round</span>(auc_upper, <span class="dv">2</span>),</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_negative =</span> n_neg,</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_positive =</span> n_pos</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(summary_table)</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (output <span class="sc">==</span> <span class="st">"chart"</span>) {</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build a tidy data frame for plotting</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    roc.curve <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">TPR =</span> rocit_obj<span class="sc">$</span>TPR,  <span class="co"># True Positive Rate (sensitivity)</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">FPR =</span> rocit_obj<span class="sc">$</span>FPR   <span class="co"># False Positive Rate (1 - specificity)</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot ROC curve using ggplot2</span></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> roc.curve, <span class="fu">aes</span>(<span class="at">x =</span> FPR, <span class="at">y =</span> TPR)) <span class="sc">+</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">color =</span> curve_color, <span class="at">size =</span> <span class="fl">1.2</span>, <span class="at">linetype =</span> lty) <span class="sc">+</span>  <span class="co"># Draw ROC curve</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey50"</span>) <span class="sc">+</span>  <span class="co"># Diagonal reference line</span></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>      <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.6</span>, <span class="at">y =</span> <span class="fl">0.05</span>, <span class="at">label =</span> auc_label, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span>  <span class="co"># AUC annotation</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> title, <span class="at">x =</span> <span class="st">"False Positive Rate (1 - Specificity)"</span>, <span class="at">y =</span> <span class="st">"True Positive Rate (Sensitivity)"</span>) <span class="sc">+</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>)  <span class="co"># Clean, readable theme</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(p)  <span class="co"># Return the ggplot object</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Invalid output option. Use 'chart' or 'table'."</span>)  <span class="co"># Handle incorrect output argument</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="function-to-generate-roc-tables-for-multiple-biomarkers" class="level3" data-number="17.4.3">
<h3 data-number="17.4.3" class="anchored" data-anchor-id="function-to-generate-roc-tables-for-multiple-biomarkers"><span class="header-section-number">17.4.3</span> Function to generate ROC tables for multiple biomarkers</h3>
<p>This function calculates ROC performance metrics (e.g.&nbsp;AUC, sensitivity, specificity) for a list of biomarkers against a binary outcome. It returns a tidy, combined table of ROC statistics for each biomarker, facilitating comparative evaluation and downstream reporting.</p>
<ul>
<li><p>Accepts a list of biomarkers.</p></li>
<li><p>Applies <code>ROCit_plot(..., output = "table")</code> to each one.</p></li>
<li><p>Collects the AUC results and sample sizes into a single tidy tibble.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate ROC summary tables for a list of biomarkers</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>generate_roc_tables <span class="ot">&lt;-</span> <span class="cf">function</span>(data, biomarkers, <span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>) {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Inner function that generates a ROC table for a single biomarker</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  generate_roc_table <span class="ot">&lt;-</span> <span class="cf">function</span>(score_col) {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    roc_result <span class="ot">&lt;-</span> <span class="fu">ROCit_plot</span>(</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> data,                 <span class="co"># Dataset to be used</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">score_col =</span> score_col,       <span class="co"># Column containing predictor score (biomarker)</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">class_col =</span> class_col,       <span class="co"># Outcome column (default: "dead_or_alive")</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">output =</span> <span class="st">"table"</span>             <span class="co"># Return summary table instead of plot</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add biomarker name to the output for easier identification later</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    roc_result <span class="sc">%&gt;%</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">biomarker =</span> score_col)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply the ROC table function across all biomarkers and combine the results</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  roc_tables <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(biomarkers, generate_roc_table)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return the complete ROC summary table</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(roc_tables)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="function-to-generate-a-roc-curve-conditioned-on-a-variable" class="level3" data-number="17.4.4">
<h3 data-number="17.4.4" class="anchored" data-anchor-id="function-to-generate-a-roc-curve-conditioned-on-a-variable"><span class="header-section-number">17.4.4</span> Function to generate a ROC curve conditioned on a variable</h3>
<p>This function generates stratified ROC plots for a single biomarker, comparing performance across subgroups defined by a conditioning variable (e.g.&nbsp;inpatient vs outpatient). It computes ROC curves and AUC with confidence intervals for each subgroup and the overall population, and visualises them using a colourblind-friendly ggplot.</p>
<ul>
<li><p>P<strong>lots ROC curves</strong> for a biomarker across different groups (e.g.&nbsp;male vs female).</p></li>
<li><p>A<strong>lways includes an “Overall” curve</strong> for the full dataset.</p></li>
<li><p>Uses <strong>AUC with 95% CI</strong> to label each group.</p></li>
<li><p>Handles edge cases gracefully (e.g.&nbsp;skips groups with no variation in outcome).</p></li>
<li><p>The result is a single ggplot object showing <strong>comparative diagnostic performance</strong>.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to draw ROC curves for a biomarker across different subgroups (e.g., by sex or age group)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ROCit_plot_conditioned <span class="ot">&lt;-</span> <span class="cf">function</span>(data, score_col, class_col, <span class="at">title =</span> <span class="st">"ROC Curve"</span>, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">negate_score =</span> <span class="cn">FALSE</span>, <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">color =</span> <span class="cn">NULL</span>, </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">conditioning =</span> <span class="cn">NULL</span>) {</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load required libraries</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(ggplot2)        <span class="co"># For plotting</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dplyr)          <span class="co"># For data manipulation</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tidyr)          <span class="co"># For reshaping data</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(RColorBrewer)   <span class="co"># For colour palettes</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(ROCit)          <span class="co"># For computing ROC and AUC</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If a conditioning variable is provided, exclude any rows where that variable is "indet"</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(conditioning)) {</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">filter</span>(data, <span class="sc">!!</span><span class="fu">sym</span>(conditioning) <span class="sc">!=</span> <span class="st">"indet"</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set up a colour palette (Dark2 is colourblind-friendly)</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(color)) {</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    colors <span class="ot">&lt;-</span> <span class="fu">brewer.pal</span>(<span class="at">n =</span> <span class="dv">8</span>, <span class="st">"Dark2"</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This tibble will store all ROC curve data for plotting</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  roc_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>()</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Always compute an overall ROC curve (i.e., across all data)</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  data_list <span class="ot">&lt;-</span> <span class="fu">list</span>(data)           <span class="co"># Start with one list entry: all data</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  levels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Overall"</span>)            <span class="co"># Label this level as "Overall"</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If a conditioning variable is supplied (e.g. sex), add separate subsets for each group</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(conditioning)) {</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    cond_levels <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">as.character</span>(data[[conditioning]]))  <span class="co"># Get unique levels</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    levels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Overall"</span>, cond_levels)                        <span class="co"># Label groups for plot</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a list of data frames split by condition</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    data_list <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(data),</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lapply</span>(cond_levels, <span class="cf">function</span>(level) {</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(data, <span class="sc">!!</span><span class="fu">sym</span>(conditioning) <span class="sc">==</span> level)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop over each subset (overall + each subgroup)</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(data_list)) {</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    subset_data <span class="ot">&lt;-</span> data_list[[i]]</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip this subset if it doesn't have at least two different outcome values</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(subset_data[[class_col]])) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Skipping level '"</span>, levels[i], <span class="st">"' because it has fewer than two unique values in '"</span>, class_col, <span class="st">"'."</span>)</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use negative scores if specified (useful when low scores indicate higher risk)</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    score_values <span class="ot">&lt;-</span> <span class="cf">if</span> (negate_score) <span class="sc">-</span>subset_data[[score_col]] <span class="cf">else</span> subset_data[[score_col]]</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute ROC curve and AUC</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    rocit_obj <span class="ot">&lt;-</span> <span class="fu">rocit</span>(<span class="at">score =</span> score_values, <span class="at">class =</span> subset_data[[class_col]])</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    auc_ci <span class="ot">&lt;-</span> <span class="fu">ciAUC</span>(rocit_obj, <span class="at">method =</span> <span class="st">"bootstrap"</span>, <span class="at">boot.n =</span> <span class="dv">1000</span>)</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract AUC and confidence intervals</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    auc_value <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(rocit_obj<span class="sc">$</span>AUC)</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    auc_lower <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(auc_ci<span class="sc">$</span>lower)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    auc_upper <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(auc_ci<span class="sc">$</span>upper)</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add results to the plotting data frame with subgroup label and AUC</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    roc_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>      roc_data,</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">TPR =</span> rocit_obj<span class="sc">$</span>TPR,   <span class="co"># True Positive Rate</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">FPR =</span> rocit_obj<span class="sc">$</span>FPR,   <span class="co"># False Positive Rate</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">group =</span> <span class="fu">paste0</span>(levels[i], <span class="st">" (AUC: "</span>, <span class="fu">round</span>(auc_value, <span class="dv">2</span>),</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>                       <span class="st">" ["</span>, <span class="fu">round</span>(auc_lower, <span class="dv">2</span>), <span class="st">"–"</span>, <span class="fu">round</span>(auc_upper, <span class="dv">2</span>), <span class="st">"])"</span>)</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot ROC curves for all groups</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(roc_data, <span class="fu">aes</span>(<span class="at">x =</span> FPR, <span class="at">y =</span> TPR, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>, <span class="at">linetype =</span> lty) <span class="sc">+</span>                                     <span class="co"># Main ROC curve</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey50"</span>) <span class="sc">+</span>  <span class="co"># Reference line</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(roc_data<span class="sc">$</span>group))]) <span class="sc">+</span>    <span class="co"># Manual color assignment</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> title, <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>, <span class="at">color =</span> <span class="cn">NULL</span>) <span class="sc">+</span>                    <span class="co"># Minimal axis labels</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span>                                            <span class="co"># Clean theme</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"cm"</span>),</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)                                   <span class="co"># Centered title</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p)  <span class="co"># Return the ggplot object</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="function-to-estimate-luminex-standard-curve-and-predict-concentrations-for-all-plates-and-assays" class="level3" data-number="17.4.5">
<h3 data-number="17.4.5" class="anchored" data-anchor-id="function-to-estimate-luminex-standard-curve-and-predict-concentrations-for-all-plates-and-assays"><span class="header-section-number">17.4.5</span> Function to Estimate Luminex Standard Curve and Predict Concentrations for All Plates and Assays</h3>
<p>This function fits a 4-parameter logistic (4PL) model to Luminex assay standard data for a specific plate and analyte. It uses this model to convert log-transformed MFI values into estimated concentrations for specimens, applying a lower bound to avoid extrapolation below the lowest standard.</p>
<ul>
<li><p>Uses a <strong>subset of assay data</strong> from one plate to fit a <strong>4-parameter logistic curve</strong> (4PL) relating MFI to known concentrations.</p></li>
<li><p>Then, it <strong>predicts log10 concentrations</strong> for unknown samples based on their MFI.</p></li>
<li><p>It <strong>avoids extrapolating below</strong> the lowest standard but allows extrapolation above the highest.</p></li>
<li><p>If model fitting fails (e.g.&nbsp;due to bad standards), it exits gracefully and returns the original data.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to estimate specimen concentrations on a specific plate and assay using a 4-parameter logistic (4PL) standard curve</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>luminex_standard_curve_estimator <span class="ot">&lt;-</span> <span class="cf">function</span>(data, test_plate, test_assay) {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1: Filter dataset for the selected plate and assay</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">filter</span>(data, plate <span class="sc">==</span> test_plate, assay <span class="sc">==</span> test_assay)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Extract the minimum and maximum standard concentrations</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># These are used for bounds and interpretation, based on known standard samples</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  min_standard <span class="ot">&lt;-</span> <span class="fu">filter</span>(x, class <span class="sc">==</span> <span class="st">"standard"</span>, sample <span class="sc">==</span> <span class="st">"S7"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">min_conc =</span> <span class="fu">min</span>(conc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(min_conc)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  max_standard <span class="ot">&lt;-</span> <span class="fu">filter</span>(x, class <span class="sc">==</span> <span class="st">"standard"</span>, sample <span class="sc">==</span> <span class="st">"S1"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">max_conc =</span> <span class="fu">max</span>(conc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(max_conc)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 3: Transform both MFI and concentration to log10 scale</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This helps to linearise the central part of the 4PL curve</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">log10_mfi =</span> <span class="fu">log10</span>(mfi),</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">log10_conc =</span> <span class="fu">log10</span>(conc)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(sample <span class="sc">!=</span> <span class="st">"S8"</span>)  <span class="co"># Exclude the buffer-only blank sample (S8)</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 4: Split dataset into standard and specimen groups</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  x_standards <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> <span class="fu">filter</span>(class <span class="sc">==</span> <span class="st">"standard"</span>, log10_mfi <span class="sc">&gt;=</span> <span class="dv">0</span>)  <span class="co"># Keep only valid MFI values</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  x_samples <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> <span class="fu">filter</span>(class <span class="sc">!=</span> <span class="st">"standard"</span>, log10_mfi <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 5: Fit a 4-parameter logistic (4PL) model using standard data</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This models the relationship between log10(MFI) and log10(concentration)</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  model1 <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drm</span>(log10_conc <span class="sc">~</span> log10_mfi,</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">fct =</span> <span class="fu">LL.4</span>(<span class="at">names =</span> <span class="fu">c</span>(<span class="st">"Slope"</span>, <span class="st">"Lower"</span>, <span class="st">"Upper"</span>, <span class="st">"ED50"</span>)),</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> x_standards),</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Handle cases where the model fails to converge</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"4PL model fitting failed for plate: "</span>, test_plate, <span class="st">" assay: "</span>, test_assay)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 6: If model was successful, use it to estimate concentrations for specimens</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(model1)) {</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">Estimate =</span> <span class="fu">predict</span>(model1, <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">log10_mfi =</span> log10_mfi)),</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply a lower bound to predictions (avoid values below min standard)</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Upper bound is commented out – optionally enforce with: log10(max_standard)</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">Estimate =</span> <span class="fu">pmax</span>(Estimate, <span class="fu">log10</span>(min_standard))</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 7: Return the augmented data frame (with estimates added if available)</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x)</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="function-to-apply-standard-curve-estimation-across-all-plates-and-assays" class="level3" data-number="17.4.6">
<h3 data-number="17.4.6" class="anchored" data-anchor-id="function-to-apply-standard-curve-estimation-across-all-plates-and-assays"><span class="header-section-number">17.4.6</span> Function to Apply Standard Curve Estimation Across All Plates and Assays</h3>
<p>This function applies the <code>luminex_standard_curve_estimator()</code> across all unique plate–assay combinations in the dataset. It returns a single, combined dataframe with estimated concentrations for all analytes on all plates.</p>
<ul>
<li><p>Looks at <strong>every unique plate and assay pair</strong> in your data.</p></li>
<li><p>Runs the <strong>4PL model fitting and prediction</strong> for each one.</p></li>
<li><p>Returns a single, tidy dataframe where each row includes the <strong>original MFI and the estimated concentration</strong> (on a log10 scale).</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to apply the standard curve estimator across all plate-assay combinations in the dataset</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>apply_luminex_standard_curve <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1: Identify all unique combinations of plate and assay</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This assumes that each plate-assay pair has its own standard curve</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  unique_combinations <span class="ot">&lt;-</span> <span class="fu">distinct</span>(data, plate, assay)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: For each plate-assay combination, estimate concentrations using the luminex_standard_curve_estimator()</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># - map2_dfr() applies the function across two parallel vectors (plate and assay)</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># - .x refers to each plate, .y refers to each assay</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># - _dfr binds all the results into a single dataframe row-wise</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">map2_dfr</span>(unique_combinations<span class="sc">$</span>plate, unique_combinations<span class="sc">$</span>assay,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>                      <span class="sc">~</span> <span class="fu">luminex_standard_curve_estimator</span>(data, .x, .y))</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 3: Return the combined results with estimated concentrations for all specimens</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="function-to-plot-positive-predictive-values" class="level3" data-number="17.4.7">
<h3 data-number="17.4.7" class="anchored" data-anchor-id="function-to-plot-positive-predictive-values"><span class="header-section-number">17.4.7</span> Function to plot Positive Predictive Values</h3>
<p>This function generates a diagnostic curve showing how the Positive Predictive Value (PPV) and Negative Predictive Value (NPV) of a biomarker vary across different decision thresholds. It uses ROC-derived sensitivity and specificity to compute predictive values and visualises them with <code>ggplot2</code>.</p>
<ul>
<li><p><strong>Calculates and plots</strong> how <strong>PPV (positive predictive value)</strong> and <strong>NPV (negative predictive value)</strong> change across the full range of thresholds for a diagnostic test or biomarker.</p></li>
<li><p>It does this by first computing a <strong>ROC curve</strong> and then applying <strong>Bayes’ theorem</strong> to convert sensitivity/specificity and prevalence into predictive values.</p></li>
<li><p>The plot shows whether a test becomes more reliable at specific cut-offs, helping guide <strong>threshold selection</strong> in clinical or diagnostic settings.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to plot Positive Predictive Value (PPV) and Negative Predictive Value (NPV) across all thresholds</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>plot_ppv <span class="ot">&lt;-</span> <span class="cf">function</span>(data, outcome, marker, <span class="at">failcode =</span> <span class="cn">NULL</span>, <span class="at">title =</span> <span class="st">"Predictive Value Curve"</span>, <span class="at">colppv =</span> <span class="st">"#000000"</span>, <span class="at">colnpv =</span> <span class="st">"#982873"</span>) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load necessary libraries</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(ggplot2)  <span class="co"># For plotting</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(pROC)     <span class="co"># For ROC curve calculation</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1: Determine the "positive" class</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If a specific failcode is provided and found in the outcome, use it</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Otherwise, default to the second level of the factor as the positive class</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(failcode) <span class="sc">&amp;&amp;</span> failcode <span class="sc">%in%</span> <span class="fu">levels</span>(<span class="fu">factor</span>(data[[outcome]]))) {</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    pos_class <span class="ot">&lt;-</span> failcode</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    pos_class <span class="ot">&lt;-</span> <span class="fu">levels</span>(<span class="fu">factor</span>(data[[outcome]]))[<span class="dv">2</span>]</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Convert outcome to binary: 1 = positive class, 0 = other</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>outcome_binary <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[outcome]] <span class="sc">==</span> pos_class)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 3: Generate an ROC curve object</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pROC::roc() returns thresholds, sensitivities, and specificities</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(data<span class="sc">$</span>outcome_binary, data[[marker]], <span class="at">direction =</span> <span class="st">"&lt;"</span>)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 4: Calculate prevalence (proportion of positive outcomes)</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  prevalence <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>outcome_binary)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 5: Extract threshold-dependent sensitivity and specificity</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  thresholds  <span class="ot">&lt;-</span> roc_obj<span class="sc">$</span>thresholds</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  sensitivity <span class="ot">&lt;-</span> roc_obj<span class="sc">$</span>sensitivities</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  specificity <span class="ot">&lt;-</span> roc_obj<span class="sc">$</span>specificities</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 6: Calculate PPV and NPV at each threshold using Bayes' theorem</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  ppv <span class="ot">&lt;-</span> (sensitivity <span class="sc">*</span> prevalence) <span class="sc">/</span> (sensitivity <span class="sc">*</span> prevalence <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> specificity) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> prevalence))</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  npv <span class="ot">&lt;-</span> (specificity <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> prevalence)) <span class="sc">/</span> (specificity <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> prevalence) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> sensitivity) <span class="sc">*</span> prevalence)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 7: Handle divide-by-zero cases by setting NaNs to NA</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  ppv[<span class="fu">is.nan</span>(ppv)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  npv[<span class="fu">is.nan</span>(npv)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 8: Combine data into a dataframe for plotting</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>  roc_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(thresholds, ppv, npv)</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 9: Plot PPV and NPV curves over all thresholds</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(roc_data, <span class="fu">aes</span>(<span class="at">x =</span> thresholds)) <span class="sc">+</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ppv, <span class="at">color =</span> colppv), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span>     <span class="co"># PPV line</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> npv, <span class="at">color =</span> colnpv), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span>     <span class="co"># NPV line</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> title,</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Threshold"</span>,</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Predictive Value"</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>)  <span class="co"># Clamp values to [0, 1] for interpretability</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="function-to-compute-confusion-matrix-statistics" class="level3" data-number="17.4.8">
<h3 data-number="17.4.8" class="anchored" data-anchor-id="function-to-compute-confusion-matrix-statistics"><span class="header-section-number">17.4.8</span> Function to compute confusion matrix statistics</h3>
<p>This function evaluates the diagnostic performance of a binary decision rule (e.g.&nbsp;<code>marker &gt; threshold</code>) by computing a full confusion matrix and associated classification statistics including sensitivity, specificity, PPV, NPV, accuracy, balanced accuracy, and McNemar’s test p-value. It returns a tidy summary of these metrics for a given condition.</p>
<ul>
<li><p>Takes a <strong>logical condition</strong> (like <code>marker &gt; 10</code>) and applies it to the dataset to create a <strong>synthetic prediction</strong> of who will die or survive.</p></li>
<li><p>Compares those predictions to the <strong>actual outcome</strong> (<code>dead_or_alive</code>) using a <strong>confusion matrix</strong>.</p></li>
<li><p>Then, calculates a full set of <strong>diagnostic performance metrics</strong> like:</p>
<ul>
<li><p>Sensitivity (recall)</p></li>
<li><p>Specificity</p></li>
<li><p>PPV / NPV</p></li>
<li><p>Accuracy and balanced accuracy</p></li>
<li><p>McNemar’s test p-value (checks symmetry in prediction errors)</p></li>
</ul></li>
<li><p>Returns all of this in a <strong>tidy, easily interpreted tibble</strong>, making it useful for grid search or ROC threshold evaluation.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute classification metrics based on a logical condition</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The condition is used to classify rows as "dead" or "alive" based on any biomarker or rule</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Returns a tidy summary of sensitivity, specificity, PPV, NPV, accuracy, and confusion matrix counts</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>compute_conf_matrix_stats <span class="ot">&lt;-</span> <span class="cf">function</span>(data, condition, <span class="at">outcome_col =</span> <span class="st">"dead_or_alive"</span>) {</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load required libraries</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dplyr)      <span class="co"># For data manipulation</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(caret)      <span class="co"># For confusionMatrix() and performance metrics</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(rlang)      <span class="co"># For parsing string-based logical expressions</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1: Apply the user-defined condition to classify predicted outcomes</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The string condition is parsed and evaluated row-wise</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">synthetic_risk =</span> <span class="fu">case_when</span>(</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!!</span><span class="fu">parse_expr</span>(condition) <span class="sc">~</span> <span class="st">"Dead"</span>,  <span class="co"># If the condition is TRUE, classify as "dead"</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Alive"</span>                     <span class="co"># Otherwise, classify as "alive"</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Standardise factor levels to ensure they match for comparison</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This prevents errors when creating the confusion matrix</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">synthetic_risk =</span> <span class="fu">factor</span>(synthetic_risk, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alive"</span>, <span class="st">"Dead"</span>)),  <span class="co"># Predicted values</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">actual_outcome =</span> <span class="fu">factor</span>(<span class="sc">!!</span><span class="fu">sym</span>(outcome_col), <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alive"</span>, <span class="st">"Dead"</span>))  <span class="co"># Actual outcome</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 3: Create a 2x2 confusion matrix of predicted vs actual outcomes</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rows = predicted values, columns = actual outcomes</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>  conf_matrix <span class="ot">&lt;-</span> <span class="fu">table</span>(data<span class="sc">$</span>synthetic_risk, data<span class="sc">$</span>actual_outcome)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 4: Compute classification performance statistics using caret</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Includes sensitivity, specificity, PPV, NPV, accuracy, and McNemar’s test</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  cf <span class="ot">&lt;-</span> <span class="fu">confusionMatrix</span>(conf_matrix, <span class="at">positive =</span> <span class="st">"Dead"</span>)  <span class="co"># Specify "dead" as the positive class</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 5: Extract metrics and return them in a tidy tibble</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This format is easy to combine, filter, or present in a table</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">condition        =</span> condition,                           <span class="co"># The condition used to classify rows</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">PPV              =</span> cf<span class="sc">$</span>byClass[<span class="st">"Pos Pred Value"</span>],        <span class="co"># Positive Predictive Value</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">NPV              =</span> cf<span class="sc">$</span>byClass[<span class="st">"Neg Pred Value"</span>],        <span class="co"># Negative Predictive Value</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">sensitivity      =</span> cf<span class="sc">$</span>byClass[<span class="st">"Sensitivity"</span>],           <span class="co"># True positive rate</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">specificity      =</span> cf<span class="sc">$</span>byClass[<span class="st">"Specificity"</span>],           <span class="co"># True negative rate</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">accuracy         =</span> cf<span class="sc">$</span>overall[<span class="st">"Accuracy"</span>],              <span class="co"># Overall correct classification rate</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">accuracylower    =</span> cf<span class="sc">$</span>overall[<span class="st">"AccuracyLower"</span>],         <span class="co"># Lower bound of 95% CI for accuracy</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">accuracyupper    =</span> cf<span class="sc">$</span>overall[<span class="st">"AccuracyUpper"</span>],         <span class="co"># Upper bound of 95% CI for accuracy</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">balancedaccuracy =</span> cf<span class="sc">$</span>byClass[<span class="st">"Balanced Accuracy"</span>],     <span class="co"># Mean of sensitivity and specificity</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">mcnemarp         =</span> cf<span class="sc">$</span>overall[<span class="st">"McnemarPValue"</span>],         <span class="co"># McNemar’s test p-value for symmetry</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_neg         =</span> cf<span class="sc">$</span>table[<span class="dv">1</span>],                         <span class="co"># True negatives (pred = alive, actual = alive)</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">false_neg        =</span> cf<span class="sc">$</span>table[<span class="dv">2</span>],                         <span class="co"># False negatives (pred = alive, actual = dead)</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">false_pos        =</span> cf<span class="sc">$</span>table[<span class="dv">3</span>],                         <span class="co"># False positives (pred = dead, actual = alive)</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_pos         =</span> cf<span class="sc">$</span>table[<span class="dv">4</span>]                          <span class="co"># True positives (pred = dead, actual = dead)</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="plate-setup-and-data-reading" class="level2" data-number="17.5">
<h2 data-number="17.5" class="anchored" data-anchor-id="plate-setup-and-data-reading"><span class="header-section-number">17.5</span> Plate Setup and data reading</h2>
<section id="setup-plate-data" class="level3" data-number="17.5.1">
<h3 data-number="17.5.1" class="anchored" data-anchor-id="setup-plate-data"><span class="header-section-number">17.5.1</span> Setup Plate data</h3>
<p>This code loads and processes all raw Luminex assay <code>.csv</code> files from the <code>data/luminex_files_zimbabwe/</code> directory:</p>
<ul>
<li><p><strong>File discovery:</strong> <code>list.files()</code> identifies all files in the target folder with full paths.</p></li>
<li><p><strong>File processing:</strong> Each file is passed to the <code>luminex.process.data()</code> function to extract and tidy the MFI and bead count data, merge in standard concentrations, and label metadata.</p></li>
<li><p><strong>Row binding:</strong> All resulting data frames are combined into a single <code>df</code> using <code>bind_rows()</code>.</p></li>
<li><p><strong>Plate labelling:</strong> The <code>plate</code> variable is cleaned by removing the directory path prefix (<code>data/luminex_files_zimbabwe//plate_</code>).</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>c.files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"data/luminex_files_simulated//"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>(<span class="fu">bind_rows</span>(<span class="fu">lapply</span>(c.files, <span class="cf">function</span>(x) <span class="fu">luminex.process.data</span>(<span class="at">file =</span> x, <span class="at">standards.file =</span> <span class="st">"data/MOSDEF_Standard_Concs.csv"</span>)))) <span class="sc">%&gt;%</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">plate =</span> <span class="fu">str_remove</span>(plate,<span class="st">"data/luminex_files_zimbabwe//plate_"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="standards" class="level3" data-number="17.5.2">
<h3 data-number="17.5.2" class="anchored" data-anchor-id="standards"><span class="header-section-number">17.5.2</span> Standards</h3>
<p>The main purpose of the standards is to ensure that per-plate and per-assay, the standard curve specimens return MFI values that follow a dose-response curve.<br>
</p>
<p>Any assays where this isn’t the case should be removed, or at least adjusted for batch effects.</p>
<p>This requires a standards file to be provided (see MOSDEF_Standard_Concs.csv). It should look like the one below. Beware that the names of the assays and the names of the standards both need to match exactly to those in the data sets. Standard 8 is a background control (i.e.&nbsp;buffer blank). You could manually build this if you wanted to with the tibble command.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>standards <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">"data/MOSDEF_Standard_Concs.csv"</span>,<span class="at">show_col_types =</span> F)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(standards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 12%">
<col style="width: 13%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 3%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">assay</th>
<th style="text-align: left;">unit</th>
<th style="text-align: right;">S1</th>
<th style="text-align: right;">S2</th>
<th style="text-align: right;">S3</th>
<th style="text-align: right;">S4</th>
<th style="text-align: right;">S5</th>
<th style="text-align: right;">S6</th>
<th style="text-align: right;">S7</th>
<th style="text-align: right;">S8</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CRP</td>
<td style="text-align: left;">pg_ml</td>
<td style="text-align: right;">10000</td>
<td style="text-align: right;">2500.0</td>
<td style="text-align: right;">625.000</td>
<td style="text-align: right;">156.25000</td>
<td style="text-align: right;">39.0625000</td>
<td style="text-align: right;">9.7656250</td>
<td style="text-align: right;">2.4414062</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">sTREM1</td>
<td style="text-align: left;">pg_ml</td>
<td style="text-align: right;">10000</td>
<td style="text-align: right;">2500.0</td>
<td style="text-align: right;">625.000</td>
<td style="text-align: right;">156.25000</td>
<td style="text-align: right;">39.0625000</td>
<td style="text-align: right;">9.7656250</td>
<td style="text-align: right;">2.4414062</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ang-2</td>
<td style="text-align: left;">ng_ml</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">25.0</td>
<td style="text-align: right;">6.250</td>
<td style="text-align: right;">1.56250</td>
<td style="text-align: right;">0.3906250</td>
<td style="text-align: right;">0.0976562</td>
<td style="text-align: right;">0.0244141</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Ang-1</td>
<td style="text-align: left;">ng_ml</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">12.5</td>
<td style="text-align: right;">3.125</td>
<td style="text-align: right;">0.78125</td>
<td style="text-align: right;">0.1953125</td>
<td style="text-align: right;">0.0488281</td>
<td style="text-align: right;">0.0122070</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sTNF-R1</td>
<td style="text-align: left;">pg_ml</td>
<td style="text-align: right;">2500</td>
<td style="text-align: right;">625.0</td>
<td style="text-align: right;">156.250</td>
<td style="text-align: right;">39.06250</td>
<td style="text-align: right;">9.7656250</td>
<td style="text-align: right;">2.4414062</td>
<td style="text-align: right;">0.6103516</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">IL-6</td>
<td style="text-align: left;">pg_ml</td>
<td style="text-align: right;">10000</td>
<td style="text-align: right;">2500.0</td>
<td style="text-align: right;">625.000</td>
<td style="text-align: right;">156.25000</td>
<td style="text-align: right;">39.0625000</td>
<td style="text-align: right;">9.7656250</td>
<td style="text-align: right;">2.4414062</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">TRAIL</td>
<td style="text-align: left;">pg_ml</td>
<td style="text-align: right;">10000</td>
<td style="text-align: right;">2500.0</td>
<td style="text-align: right;">625.000</td>
<td style="text-align: right;">156.25000</td>
<td style="text-align: right;">39.0625000</td>
<td style="text-align: right;">9.7656250</td>
<td style="text-align: right;">2.4414062</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">IL-10</td>
<td style="text-align: left;">pg_ml</td>
<td style="text-align: right;">4000</td>
<td style="text-align: right;">1000.0</td>
<td style="text-align: right;">250.000</td>
<td style="text-align: right;">62.50000</td>
<td style="text-align: right;">15.6250000</td>
<td style="text-align: right;">3.9062500</td>
<td style="text-align: right;">0.9765625</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Azu</td>
<td style="text-align: left;">ng_ml</td>
<td style="text-align: right;">200</td>
<td style="text-align: right;">50.0</td>
<td style="text-align: right;">12.500</td>
<td style="text-align: right;">3.12500</td>
<td style="text-align: right;">0.7812500</td>
<td style="text-align: right;">0.1953125</td>
<td style="text-align: right;">0.0488281</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">MxA</td>
<td style="text-align: left;">ng_ml</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">75.0</td>
<td style="text-align: right;">18.750</td>
<td style="text-align: right;">4.68750</td>
<td style="text-align: right;">1.1718750</td>
<td style="text-align: right;">0.2929688</td>
<td style="text-align: right;">0.0732422</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IP-10</td>
<td style="text-align: left;">pg_ml</td>
<td style="text-align: right;">10000</td>
<td style="text-align: right;">2500.0</td>
<td style="text-align: right;">625.000</td>
<td style="text-align: right;">156.25000</td>
<td style="text-align: right;">39.0625000</td>
<td style="text-align: right;">9.7656250</td>
<td style="text-align: right;">2.4414062</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">CH3L1</td>
<td style="text-align: left;">ng_ml</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">25.0</td>
<td style="text-align: right;">6.250</td>
<td style="text-align: right;">1.56250</td>
<td style="text-align: right;">0.3906250</td>
<td style="text-align: right;">0.0976562</td>
<td style="text-align: right;">0.0244141</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IL-8</td>
<td style="text-align: left;">pg_ml</td>
<td style="text-align: right;">2500</td>
<td style="text-align: right;">625.0</td>
<td style="text-align: right;">156.250</td>
<td style="text-align: right;">39.06250</td>
<td style="text-align: right;">9.7656250</td>
<td style="text-align: right;">2.4414062</td>
<td style="text-align: right;">0.6103516</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(standards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This code chunk visualises the standard curves for each analyte across all plates to assess for potential batch effects:</p>
<ul>
<li><p><strong>Filtering:</strong> Extracts only rows classified as <code>"standard"</code> from the full dataset (<code>df</code>).</p></li>
<li><p><strong>Plotting:</strong> For each analyte (<code>assay</code>), plots <code>log(MFI)</code> against <code>log(concentration)</code> to visualise the relationship.</p></li>
<li><p><strong>Faceting:</strong> Uses <code>facet_wrap()</code> to create separate panels per analyte, allowing comparison across assays.</p></li>
<li><p><strong>Purpose:</strong> Helps identify inconsistencies, nonlinearities, or batch variation in standard performance across plates before model fitting.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>standards<span class="ot">&lt;-</span>df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(class<span class="sc">==</span><span class="st">"standard"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualise standards to assess batch effects</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(standards,<span class="fu">aes</span>(<span class="fu">log</span>(conc),<span class="fu">log</span>(mfi)))<span class="sc">+</span><span class="fu">geom_point</span>()<span class="sc">+</span><span class="fu">geom_smooth</span>()<span class="sc">+</span><span class="fu">facet_wrap</span>(.<span class="sc">~</span>assay,<span class="at">scales =</span> <span class="st">"free"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
<p>In this example there appears to be some kind of batch effect in the MxA assay, which leads to two distinct curves. This can be plotted by individual plates in numerical series to see what is going on.</p>
</section>
<section id="plate-level-mfi-distribution-by-assay" class="level3" data-number="17.5.3">
<h3 data-number="17.5.3" class="anchored" data-anchor-id="plate-level-mfi-distribution-by-assay"><span class="header-section-number">17.5.3</span> Plate-Level MFI Distribution by Assay</h3>
<p>This plot is used to assess measurement consistency and detect plate-specific anomalies:</p>
<ul>
<li><p><strong>Input data:</strong> Uses the full dataset <code>df</code>, including both specimen and standard samples.</p></li>
<li><p><strong>Axes:</strong></p>
<ul>
<li><p><code>x = plate</code>: Each plate (from file name) on the x-axis.</p></li>
<li><p><code>y = log(mfi)</code>: Log-transformed median fluorescence intensity.</p></li>
</ul></li>
<li><p><strong>Color:</strong> Points are colored by <code>class</code> (i.e., <code>standard</code> or <code>specimen</code>).</p></li>
<li><p><strong>Faceting:</strong> A separate panel is drawn for each <code>assay</code>, allowing per-analyte inspection.</p></li>
<li><p><strong>Point styling:</strong> Uses small, semi-transparent dots to make dense plots readable.</p></li>
</ul>
<p><strong>Purpose:</strong><br>
Quick visual QC for MFI ranges across plates and analytes. Useful for spotting:</p>
<ul>
<li><p>Drifts or jumps between plates,</p></li>
<li><p>Assays with unusually high/low values,</p></li>
<li><p>Missing or outlier readings.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df,<span class="fu">aes</span>(plate,<span class="fu">log</span>(mfi),<span class="at">col=</span>class))<span class="sc">+</span><span class="fu">geom_point</span>(<span class="at">size=</span><span class="fl">0.5</span>,<span class="at">alpha=</span><span class="fl">0.5</span>)<span class="sc">+</span><span class="fu">facet_wrap</span>(.<span class="sc">~</span>assay)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
<p>Each column shows the raw data from a single plate, and here we can see that non-alignment of the standards (blue dots) suggests a batch effect (i.e.&nbsp;a batch of beads with overall lower fluorescence) in several of the assays – but most obviously in MxA.</p>
<p>Batch effects can be corrected for (to some degree) by normalisation.</p>
</section>
<section id="application-of-standard-curve-to-convert-mfi-to-concentration" class="level3" data-number="17.5.4">
<h3 data-number="17.5.4" class="anchored" data-anchor-id="application-of-standard-curve-to-convert-mfi-to-concentration"><span class="header-section-number">17.5.4</span> Application of Standard Curve to Convert MFI to Concentration</h3>
<p>This line applies the 4-parameter logistic (4PL) model to convert median fluorescence intensity (MFI) readings into estimated analyte concentrations:</p>
<p><strong>What it does:</strong></p>
<ul>
<li><p>Calls <code>apply_luminex_standard_curve()</code>, which:</p>
<ul>
<li><p>Identifies unique <code>(plate, assay)</code> combinations.</p></li>
<li><p>For each combination, invokes <code>luminex_standard_curve_estimator()</code> to:</p>
<ul>
<li><p>Fit a 4PL model using the known standard concentrations.</p></li>
<li><p>Predict concentrations for specimens using the fitted curve.</p></li>
<li><p>Apply a log10 transformation and a floor limit (based on the lowest standard).</p></li>
</ul></li>
</ul></li>
<li><p>Combines all modelled data back into a unified, tidy dataframe.</p></li>
</ul>
<p><strong>Output:</strong></p>
<ul>
<li>The returned <code>df</code> includes a new column <code>Estimate</code>, which contains the log10-transformed concentration estimates for valid, non-background specimens.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>df<span class="ot">&lt;-</span><span class="fu">apply_luminex_standard_curve</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualisation-of-fitted-concentration-estimates-across-plates" class="level3" data-number="17.5.5">
<h3 data-number="17.5.5" class="anchored" data-anchor-id="visualisation-of-fitted-concentration-estimates-across-plates"><span class="header-section-number">17.5.5</span> Visualisation of Fitted Concentration Estimates Across Plates</h3>
<p>This plot shows how the estimated concentrations (from 4PL standard curve fitting) vary by assay and plate:</p>
<p><strong>Purpose:</strong></p>
<ul>
<li><p>To <strong>assess consistency</strong> of the estimated concentrations (<code>Estimate</code>) across assay plates.</p></li>
<li><p>To <strong>detect batch effects</strong> or anomalies in specimen or standard behaviour.</p></li>
<li><p>Helps verify that the 4PL fitting worked as intended and is <strong>not introducing systematic bias</strong> between plates or assays.</p></li>
</ul>
<p>This is an important <strong>QA diagnostic</strong> step to ensure validity and comparability before downstream analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df,<span class="fu">aes</span>(plate,Estimate,<span class="at">col=</span>class))<span class="sc">+</span><span class="fu">geom_point</span>(<span class="at">size=</span><span class="fl">0.5</span>,<span class="at">alpha=</span><span class="fl">0.5</span>)<span class="sc">+</span><span class="fu">facet_wrap</span>(.<span class="sc">~</span>assay)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="remove-standards-before-further-analysis" class="level3" data-number="17.5.6">
<h3 data-number="17.5.6" class="anchored" data-anchor-id="remove-standards-before-further-analysis"><span class="header-section-number">17.5.6</span> Remove Standards Before Further Analysis</h3>
<ul>
<li><p><strong>Purpose</strong>: Ensures only experimental (specimen) data are retained for analysis.</p></li>
<li><p><strong>Why</strong>: Standard samples are reference/control values used during calibration and plate-wise normalisation steps (above) and should <strong>not</strong> be included in the z-score step, which is meant to scale specimens only.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df<span class="ot">&lt;-</span>df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    class <span class="sc">!=</span> <span class="st">"standard"</span>   <span class="co"># Remove standards before normalization</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(standards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pivot-data-to-wide-format" class="level3" data-number="17.5.7">
<h3 data-number="17.5.7" class="anchored" data-anchor-id="pivot-data-to-wide-format"><span class="header-section-number">17.5.7</span> Pivot Data to wide format</h3>
<p>This code reshapes your Luminex data into a <strong>wide format</strong>, suitable for multivariate analyses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df_wider <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="fu">c</span>(sample,test.id),<span class="at">names_from =</span> assay,<span class="at">values_from =</span> Estimate </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="normalise-scores-for-modelling-purposes" class="level3" data-number="17.5.8">
<h3 data-number="17.5.8" class="anchored" data-anchor-id="normalise-scores-for-modelling-purposes"><span class="header-section-number">17.5.8</span> Normalise scores for modelling purposes</h3>
<p>This step <strong>normalises each biomarker</strong> using <strong>z-score transformation</strong>, which centers the data (mean = 0) and scales it (SD = 1).</p>
<p><strong>What This Does:</strong></p>
<ul>
<li><p>Applies <code>scale()</code> to each biomarker:</p>
<ul>
<li><p>Subtracts the mean</p></li>
<li><p>Divides by the standard deviation</p></li>
</ul></li>
<li><p>Adds new variables (e.g.&nbsp;<code>ang_1_z</code>, <code>il_6_z</code>) representing <strong>standardised biomarker values</strong>.</p></li>
</ul>
<p><strong>Why It’s Important:</strong></p>
<ul>
<li><p>Removes differences in scale across biomarkers.</p></li>
<li><p>Essential for:</p>
<ul>
<li><p><strong>PCA</strong></p></li>
<li><p><strong>Clustering</strong></p></li>
<li><p><strong>Regression and classifiers</strong> (especially distance-based models)</p></li>
<li><p><strong>Fair visual comparisons</strong></p></li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>df_wider <span class="ot">&lt;-</span> df_wider <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">ang_1_z =</span> <span class="fu">scale</span>(ang_1)[,<span class="dv">1</span>],</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">ang_2_z =</span> <span class="fu">scale</span>(ang_2)[,<span class="dv">1</span>],</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">azu_z =</span> <span class="fu">scale</span>(azu)[,<span class="dv">1</span>],</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">ch3l1_z =</span> <span class="fu">scale</span>(ch3l1)[,<span class="dv">1</span>],</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">il_10_z =</span> <span class="fu">scale</span>(il_10)[,<span class="dv">1</span>],</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">il_6_z =</span> <span class="fu">scale</span>(il_6)[,<span class="dv">1</span>],</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">il_8_z =</span> <span class="fu">scale</span>(il_8)[,<span class="dv">1</span>],</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">ip_10_z =</span> <span class="fu">scale</span>(ip_10)[,<span class="dv">1</span>],</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">mxa_z =</span> <span class="fu">scale</span>(mxa)[,<span class="dv">1</span>],</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">stnf_r1_z =</span> <span class="fu">scale</span>(stnf_r1)[,<span class="dv">1</span>],</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">strem1_z =</span> <span class="fu">scale</span>(strem1)[,<span class="dv">1</span>],</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">trail_z =</span> <span class="fu">scale</span>(trail)[,<span class="dv">1</span>]</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="create-some-dummy-clinical-data-for-analysis" class="level2" data-number="17.6">
<h2 data-number="17.6" class="anchored" data-anchor-id="create-some-dummy-clinical-data-for-analysis"><span class="header-section-number">17.6</span> Create some dummy clinical data for analysis</h2>
<p>This block of code <strong>generates a simulated outcome variable (<code>dead_or_alive</code>)</strong> for testing classification models, using biomarker and HIV status information. This simulates a <strong>plausible binary outcome</strong> (<code>Alive</code> vs <code>Dead</code>) based on <code>il_8_z (Strong association), MxA (Moderate``association``) and CH3L1 (Moderate``association``)</code> values and a synthetic HIV status (<code>hiv_comb</code>), for downstream ROC and predictive analyses.</p>
<ul>
<li><p>Adds a <strong>randomly assigned HIV status</strong> to each sample (<code>HIV_Negative</code> or <code>HIV_Positive</code>), uniformly distributed.</p></li>
<li><p>Creates a <strong>death probability</strong> (<code>death_prob</code>) for each individual:</p>
<ul>
<li><p>For <strong>HIV-negative</strong>, death probability increases sharply with <code>il_8_z</code> (logistic function).</p></li>
<li><p>For <strong>HIV-positive</strong>, <strong>death probability is flat</strong> at 0.5 (i.e., no biomarker effect).</p></li>
</ul></li>
<li><p>Simulates the actual outcome:</p>
<ul>
<li><p>Uses <code>runif(n()) &lt; death_prob</code> to probabilistically assign “Dead” or “Alive”.</p></li>
<li><p>Forces factor levels to be <code>c("Alive", "Dead")</code> so that ROC calculations interpret <strong>“Dead” as the positive class</strong>.</p></li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>df_wider <span class="ot">&lt;-</span> df_wider <span class="sc">%&gt;%</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">hiv_comb =</span> <span class="fu">as_factor</span>(<span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"HIV_Negative"</span>, <span class="st">"HIV_Positive"</span>), </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">size =</span> <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">death_prob =</span> <span class="fu">case_when</span>(</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Strong nonlinear IL-8 effect for HIV-negative, plus moderate effects from MxA and CH3L1</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>      hiv_comb <span class="sc">==</span> <span class="st">"HIV_Negative"</span> <span class="sc">~</span> <span class="fu">plogis</span>(<span class="dv">3</span> <span class="sc">*</span> il_8_z <span class="sc">+</span> <span class="fl">1.0</span> <span class="sc">*</span> mxa_z <span class="sc">+</span> <span class="fl">0.6</span> <span class="sc">*</span> ch3l1_z),</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>      <span class="co"># No IL-8 effect for HIV-positive, but keep moderate effects from MxA and CH3L1</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>      hiv_comb <span class="sc">==</span> <span class="st">"HIV_Positive"</span> <span class="sc">~</span> <span class="fu">plogis</span>(<span class="dv">0</span> <span class="sc">+</span> <span class="fl">1.0</span> <span class="sc">*</span> mxa_z <span class="sc">+</span> <span class="fl">0.6</span> <span class="sc">*</span> ch3l1_z)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">dead_or_alive =</span> <span class="fu">factor</span>(</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(<span class="fu">runif</span>(<span class="fu">n</span>()) <span class="sc">&lt;</span> death_prob, <span class="st">"Dead"</span>, <span class="st">"Alive"</span>),</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alive"</span>, <span class="st">"Dead"</span>)  <span class="co"># ensure ROCit uses "Dead" as positive class</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="example-analyses" class="level2" data-number="17.7">
<h2 data-number="17.7" class="anchored" data-anchor-id="example-analyses"><span class="header-section-number">17.7</span> Example Analyses</h2>
<section id="roc-analysis" class="level3" data-number="17.7.1">
<h3 data-number="17.7.1" class="anchored" data-anchor-id="roc-analysis"><span class="header-section-number">17.7.1</span> ROC Analysis</h3>
<p>This line of code plots a <strong>Receiver Operating Characteristic (ROC) curve</strong> for the <strong>IL-8</strong> biomarker against the binary outcome <code>dead_or_alive</code>, using the custom <code>ROCit_plot()</code> function.</p>
<ul>
<li><p>Evaluates how well <strong>IL-8</strong> predicts mortality.</p></li>
<li><p>Displays a ROC curve and associated AUC.</p></li>
<li><p>Visualises the <strong>trade-off between sensitivity and specificity</strong> at different thresholds.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ROCit_plot</span>(<span class="at">data=</span>df_wider,<span class="at">score_col =</span> <span class="st">"il_8"</span>,<span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>,<span class="at">color =</span> <span class="st">"#000000"</span>)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"IL-8"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="roc-analysis-of-more-than-one-marker-using-patchwork" class="level3" data-number="17.7.2">
<h3 data-number="17.7.2" class="anchored" data-anchor-id="roc-analysis-of-more-than-one-marker-using-patchwork"><span class="header-section-number">17.7.2</span> ROC Analysis of more than one marker using patchwork</h3>
<p>This section compares the performance of <strong>IL-8</strong> and <strong>IL-10</strong> as mortality predictors using side-by-side ROC plots. By plotting the <strong>z-score normalised</strong> values, it enables <strong>direct visual comparison</strong> of biomarkers on the same scale, regardless of their original measurement units or dynamic ranges. This standardisation supports fair interpretation of <strong>relative predictive power</strong> across different analytes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ROCit_plot</span>(<span class="at">data=</span>df_wider,<span class="at">score_col =</span> <span class="st">"il_8_z"</span>,<span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>,<span class="at">color =</span> <span class="st">"#000000"</span>)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"IL-8"</span>) <span class="sc">+</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ROCit_plot</span>(<span class="at">data=</span>df_wider,<span class="at">score_col =</span> <span class="st">"ch3l1_z"</span>,<span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>,<span class="at">color =</span> <span class="st">"#000000"</span>)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"CH3L1"</span>) <span class="sc">+</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ROCit_plot</span>(<span class="at">data=</span>df_wider,<span class="at">score_col =</span> <span class="st">"mxa_z"</span>,<span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>,<span class="at">color =</span> <span class="st">"#000000"</span>)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"MxA"</span>) <span class="sc">+</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ROCit_plot</span>(<span class="at">data=</span>df_wider,<span class="at">score_col =</span> <span class="st">"il_10_z"</span>,<span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>,<span class="at">color =</span> <span class="st">"#000000"</span>)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"IL-10"</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="roc-table" class="level3" data-number="17.7.3">
<h3 data-number="17.7.3" class="anchored" data-anchor-id="roc-table"><span class="header-section-number">17.7.3</span> ROC Table</h3>
<p>This code block computes and displays a table of ROC statistics for one or more biomarkers — <strong>IL-8</strong> and <strong>IL-10</strong>, using their <strong>z-score normalised values</strong>. Here’s a breakdown:</p>
<ul>
<li><p><strong>Function call</strong>: <code>generate_roc_tables()</code> runs ROC analysis on each biomarker and returns a table with AUC, sensitivity, specificity, and thresholds.</p></li>
<li><p><strong>Biomarkers</strong>: <code>"il_8_z"</code> and <code>"il_10_z"</code> are included in this example, but you can add more to the list of <code>biomarkers</code> in the function call.</p></li>
<li><p><strong>Sorting</strong>: Results are ordered by descending AUC to highlight the stronger predictor.</p></li>
<li><p><strong>Annotation</strong>: A new column <code>Class_Variable = "Overall"</code> is added to label this as the non-stratified (overall) analysis. You can modify this if you’re doing complicated sub-analyses.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>roc_tables_overall <span class="ot">&lt;-</span> <span class="fu">generate_roc_tables</span>(<span class="at">data =</span> df_wider, <span class="at">biomarkers =</span> <span class="fu">c</span>(<span class="st">"il_8_z"</span>,<span class="st">"ch3l1_z"</span>,<span class="st">"mxa_z"</span>,<span class="st">"il_10_z"</span>))<span class="sc">%&gt;%</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>AUC) <span class="sc">%&gt;%</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Class_Variable =</span> <span class="st">"Overall"</span>) </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(roc_tables_overall)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 7%">
<col style="width: 13%">
<col style="width: 8%">
<col style="width: 4%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 9%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Assay</th>
<th style="text-align: left;">Outcome</th>
<th style="text-align: left;">Failcode</th>
<th style="text-align: right;">AUC</th>
<th style="text-align: right;">CI_Lower</th>
<th style="text-align: right;">CI_Upper</th>
<th style="text-align: right;">n_negative</th>
<th style="text-align: right;">n_positive</th>
<th style="text-align: left;">biomarker</th>
<th style="text-align: left;">Class_Variable</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">il_8_z</td>
<td style="text-align: left;">dead_or_alive</td>
<td style="text-align: left;">Dead</td>
<td style="text-align: right;">0.69</td>
<td style="text-align: right;">0.66</td>
<td style="text-align: right;">0.71</td>
<td style="text-align: right;">800</td>
<td style="text-align: right;">720</td>
<td style="text-align: left;">il_8_z</td>
<td style="text-align: left;">Overall</td>
</tr>
<tr class="even">
<td style="text-align: left;">mxa_z</td>
<td style="text-align: left;">dead_or_alive</td>
<td style="text-align: left;">Dead</td>
<td style="text-align: right;">0.64</td>
<td style="text-align: right;">0.61</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right;">800</td>
<td style="text-align: right;">720</td>
<td style="text-align: left;">mxa_z</td>
<td style="text-align: left;">Overall</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ch3l1_z</td>
<td style="text-align: left;">dead_or_alive</td>
<td style="text-align: left;">Dead</td>
<td style="text-align: right;">0.63</td>
<td style="text-align: right;">0.60</td>
<td style="text-align: right;">0.66</td>
<td style="text-align: right;">800</td>
<td style="text-align: right;">720</td>
<td style="text-align: left;">ch3l1_z</td>
<td style="text-align: left;">Overall</td>
</tr>
<tr class="even">
<td style="text-align: left;">il_10_z</td>
<td style="text-align: left;">dead_or_alive</td>
<td style="text-align: left;">Dead</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">0.51</td>
<td style="text-align: right;">800</td>
<td style="text-align: right;">720</td>
<td style="text-align: left;">il_10_z</td>
<td style="text-align: left;">Overall</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="roc-analysis-conditioned-by-another-variable" class="level3" data-number="17.7.4">
<h3 data-number="17.7.4" class="anchored" data-anchor-id="roc-analysis-conditioned-by-another-variable"><span class="header-section-number">17.7.4</span> ROC analysis, conditioned by another variable</h3>
<p>This line generates <strong>stratified ROC plots</strong> for the biomarker <strong>IL-8 (z-score)</strong>, conditioned on HIV status.</p>
<ul>
<li><p><code>ROCit_plot_conditioned()</code> is used to create separate ROC curves by subgroup.</p></li>
<li><p><strong><code>score_col = "il_8_z"</code></strong>: The z-score normalised IL-8 biomarker is the predictor.</p></li>
<li><p><strong><code>class_col = "dead_or_alive"</code></strong>: The binary outcome variable (Alive/Dead).</p></li>
<li><p><strong><code>conditioning = "hiv_comb"</code></strong>: ROC curves are generated separately for <strong>HIV_Negative</strong> and <strong>HIV_Positive</strong> groups.</p></li>
</ul>
<p>Stratification reveals whether a biomarker performs differently in subgroups. Using <strong>z-scores</strong> allows meaningful comparison across subgroups by standardising the measurement scale.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ROCit_plot_conditioned</span>(df_wider,<span class="at">score_col =</span> <span class="st">"il_8_z"</span>,<span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>,<span class="at">conditioning =</span> <span class="st">"hiv_comb"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="metamodel" class="level3" data-number="17.7.5">
<h3 data-number="17.7.5" class="anchored" data-anchor-id="metamodel"><span class="header-section-number">17.7.5</span> Metamodel</h3>
<p>A logistic regression model (<code>meta_model_full</code>) is fitted to predict <strong>mortality (dead_or_alive)</strong> using:</p>
<ul>
<li><p>12 <strong>z-score standardised biomarkers</strong> (e.g., <code>il_8_z</code>, <code>il_10_z</code>, <code>trail_z</code>)</p></li>
<li><p><strong>HIV status</strong> (<code>hiv_comb</code>)</p></li>
</ul>
<p>This multivariable model estimates the <strong>log-odds of death</strong> for each one standard deviation increase in biomarker concentration, controlling for HIV status.</p>
<p>By using z-scores:</p>
<ul>
<li><p>Coefficients are directly comparable across biomarkers (this is crucially important!)</p></li>
<li><p>Effect sizes are interpretable as change in risk per SD increase.</p></li>
</ul>
<p>This analysis helps identify which biomarkers contribute most independently to predicting mortality.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>meta_model_full <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="fu">factor</span>(dead_or_alive) <span class="sc">~</span> ang_1_z <span class="sc">+</span> ang_2_z <span class="sc">+</span> azu_z <span class="sc">+</span> ch3l1_z <span class="sc">+</span> il_10_z <span class="sc">+</span> il_6_z <span class="sc">+</span> il_8_z <span class="sc">+</span> ip_10_z <span class="sc">+</span> mxa_z <span class="sc">+</span> stnf_r1_z <span class="sc">+</span> strem1_z <span class="sc">+</span> trail_z <span class="sc">+</span> hiv_comb, </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> df_wider, <span class="at">family =</span> binomial, <span class="at">na.action =</span> na.exclude)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(meta_model_full)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = factor(dead_or_alive) ~ ang_1_z + ang_2_z + azu_z + 
    ch3l1_z + il_10_z + il_6_z + il_8_z + ip_10_z + mxa_z + stnf_r1_z + 
    strem1_z + trail_z + hiv_comb, family = binomial, data = df_wider, 
    na.action = na.exclude)

Coefficients:
                      Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)          -0.172417   0.082490  -2.090   0.0366 *  
ang_1_z              -0.093873   0.059177  -1.586   0.1127    
ang_2_z               0.060401   0.060984   0.990   0.3220    
azu_z                -0.041166   0.058395  -0.705   0.4808    
ch3l1_z               0.536474   0.064624   8.301   &lt;2e-16 ***
il_10_z               0.009881   0.060369   0.164   0.8700    
il_6_z                0.001440   0.059054   0.024   0.9805    
il_8_z                0.853895   0.068121  12.535   &lt;2e-16 ***
ip_10_z               0.028781   0.058821   0.489   0.6246    
mxa_z                 0.674302   0.066969  10.069   &lt;2e-16 ***
stnf_r1_z             0.017600   0.059680   0.295   0.7681    
strem1_z             -0.126021   0.061325  -2.055   0.0399 *  
trail_z               0.001614   0.058715   0.027   0.9781    
hiv_combHIV_Positive  0.161612   0.117706   1.373   0.1697    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 2103.0  on 1519  degrees of freedom
Residual deviance: 1724.5  on 1506  degrees of freedom
AIC: 1752.5

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
</section>
<section id="interaction-model-biomarkers-hiv-status" class="level3" data-number="17.7.6">
<h3 data-number="17.7.6" class="anchored" data-anchor-id="interaction-model-biomarkers-hiv-status"><span class="header-section-number">17.7.6</span> <strong>Interaction Model: Biomarkers × HIV Status</strong></h3>
<p>A logistic regression model is fitted to explore whether the effects of important biomarkers on mortality differ by <strong>HIV status</strong>. This tests if the prognostic value of biomarkers changes depending on whether a person is HIV-positive or HIV-negative. Significant interaction terms indicate that HIV status modifies the effect of the biomarker on mortality.</p>
<p>This includes:</p>
<ul>
<li><p><strong>Main effects</strong> of <code>mxa_z</code>, <code>il_8_z</code>, and <code>hiv_comb</code></p></li>
<li><p><strong>Interaction terms</strong>:</p>
<ul>
<li><p><code>mxa_z:hiv_comb</code></p></li>
<li><p><code>il_8_z:hiv_comb</code></p></li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>meta_model_marker_int_hiv <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="fu">factor</span>(dead_or_alive) <span class="sc">~</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>                          mxa_z <span class="sc">*</span> hiv_comb<span class="sc">+</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                          il_8_z <span class="sc">*</span> hiv_comb<span class="sc">+</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                          ch3l1_z <span class="sc">*</span> hiv_comb  ,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">family =</span> binomial, <span class="at">data =</span> df_wider, <span class="at">na.action =</span> na.exclude)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(meta_model_marker_int_hiv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = factor(dead_or_alive) ~ mxa_z * hiv_comb + il_8_z * 
    hiv_comb + ch3l1_z * hiv_comb, family = binomial, data = df_wider, 
    na.action = na.exclude)

Coefficients:
                             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                   0.02702    0.10646   0.254 0.799625    
mxa_z                         0.88036    0.11333   7.768 7.98e-15 ***
hiv_combHIV_Positive         -0.02690    0.13606  -0.198 0.843293    
il_8_z                        2.73653    0.19932  13.729  &lt; 2e-16 ***
ch3l1_z                       0.41338    0.10846   3.811 0.000138 ***
mxa_z:hiv_combHIV_Positive    0.01381    0.15396   0.090 0.928531    
hiv_combHIV_Positive:il_8_z  -2.71450    0.21513 -12.618  &lt; 2e-16 ***
hiv_combHIV_Positive:ch3l1_z  0.34541    0.14589   2.368 0.017899 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 2103.0  on 1519  degrees of freedom
Residual deviance: 1446.3  on 1512  degrees of freedom
AIC: 1462.3

Number of Fisher Scoring iterations: 6</code></pre>
</div>
</div>
<p>The substantial drop in AIC from 1752 (without interaction) to 1462 (with interaction) suggests that including HIV interaction terms greatly improves the model fit and better explains the variance in the data.</p>
<p><strong>Interpretation:</strong></p>
<ul>
<li><p><strong>Lower AIC</strong> indicates a better-fitting model, penalised for complexity.</p></li>
<li><p>A decrease of <strong>&gt;10</strong> is generally considered strong evidence in favour of the more complex model.</p></li>
<li><p>Here, the reduction of around 300 points is very strong evidence that:</p>
<blockquote class="blockquote">
<p>The prognostic effects of IL-8 and MXA differ significantly by HIV status.</p>
</blockquote></li>
</ul>
<p>This supports including interaction terms in subsequent modelling or stratified analyses.</p>
</section>
<section id="ppvnpv-charts" class="level3" data-number="17.7.7">
<h3 data-number="17.7.7" class="anchored" data-anchor-id="ppvnpv-charts"><span class="header-section-number">17.7.7</span> PPV/NPV charts</h3>
<p>This code block generates <strong>Positive Predictive Value (PPV)</strong> and <strong>Negative Predictive Value (NPV)</strong> curves for the biomarker <strong>IL-8</strong> across three groups, using <code>plot_ppv()</code> and combining the outputs with <code>patchwork</code>.</p>
<p>These plots allow visual comparison of <strong>diagnostic utility</strong> (PPV and NPV across thresholds) of IL-8:</p>
<ul>
<li><p>In the full population</p></li>
<li><p>Stratified by <strong>HIV status</strong></p>
<p>By conditioning on HIV, the analysis highlights whether <strong>predictive value changes by subgroup</strong>, supporting the interaction findings in the logistic models.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ppv</span>(df_wider, <span class="st">"dead_or_alive"</span>, <span class="st">"il_8_z"</span>, <span class="at">title =</span> <span class="st">"IL-8"</span>,<span class="at">failcode =</span> <span class="st">"Dead"</span>)<span class="sc">+</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ppv</span>(<span class="fu">filter</span>(df_wider,hiv_comb<span class="sc">==</span><span class="st">"HIV_Positive"</span>), <span class="st">"dead_or_alive"</span>, <span class="st">"il_8_z"</span>, <span class="at">title =</span> <span class="st">"IL-8 (HIV Positive)"</span>,<span class="at">failcode =</span> <span class="st">"Dead"</span>)<span class="sc">+</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_ppv</span>(<span class="fu">filter</span>(df_wider,hiv_comb<span class="sc">==</span><span class="st">"HIV_Negative"</span>), <span class="st">"dead_or_alive"</span>, <span class="st">"il_8_z"</span>, <span class="at">title =</span> <span class="st">"IL-8 (HIV Negative)"</span>,<span class="at">failcode =</span> <span class="st">"Dead"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
<p>It’s clear in this simulation that HIV status is a very important factor with relation to the diagnostic utility of IL-8.</p>
</section>
<section id="calculate-confusion-matrix-based-on-a-chosen-threshold" class="level3" data-number="17.7.8">
<h3 data-number="17.7.8" class="anchored" data-anchor-id="calculate-confusion-matrix-based-on-a-chosen-threshold"><span class="header-section-number">17.7.8</span> Calculate confusion Matrix based on a chosen threshold</h3>
<p>This line of code runs a <strong>confusion matrix analysis</strong> for the subset of participants who are <strong>HIV-negative</strong>, using a decision rule based on the PPV/NPV data for the <strong>IL-8 z-score</strong></p>
<ul>
<li><p><strong>Filters</strong> the data to include only HIV-negative individuals.</p></li>
<li><p><strong>Applies the rule:</strong> <code>il_8_z &gt; 0.2</code> → Predicts <strong>“dead”</strong>, otherwise <strong>“alive”</strong>.</p></li>
<li><p><strong>Creates</strong> a synthetic classification variable (<code>synthetic_risk</code>) from that rule.</p></li>
<li><p><strong>Compares</strong> predictions to actual outcomes (<code>dead_or_alive</code>) using a <strong>confusion matrix</strong>.</p></li>
<li><p><strong>Returns</strong> a tibble of metrics:</p>
<ul>
<li><p>Sensitivity, Specificity</p></li>
<li><p>Positive Predictive Value (PPV), Negative Predictive Value (NPV)</p></li>
<li><p>Accuracy and confidence bounds</p></li>
<li><p>McNemar’s test p-value</p></li>
<li><p>True/false positive and negative counts</p></li>
</ul>
<p>This lets you <strong>quantify performance</strong> of a <strong>rule-based classifier</strong> at a <strong>specific threshold</strong>, which complements the continuous-threshold analyses like ROC and PPV curves.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">compute_conf_matrix_stats</span>(<span class="at">data =</span> <span class="fu">filter</span>(df_wider,hiv_comb<span class="sc">==</span><span class="st">"HIV_Negative"</span>),<span class="at">condition =</span> <span class="st">"il_8_z&gt;0.2"</span>,<span class="at">outcome_col =</span> <span class="st">"dead_or_alive"</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 7%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 6%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 11%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">condition</th>
<th style="text-align: right;">PPV</th>
<th style="text-align: right;">NPV</th>
<th style="text-align: right;">sensitivity</th>
<th style="text-align: right;">specificity</th>
<th style="text-align: right;">accuracy</th>
<th style="text-align: right;">accuracylower</th>
<th style="text-align: right;">accuracyupper</th>
<th style="text-align: right;">balancedaccuracy</th>
<th style="text-align: right;">mcnemarp</th>
<th style="text-align: right;">true_neg</th>
<th style="text-align: right;">false_neg</th>
<th style="text-align: right;">false_pos</th>
<th style="text-align: right;">true_pos</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">il_8_z&gt;0.2</td>
<td style="text-align: right;">0.83</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.65</td>
<td style="text-align: right;">0.89</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.81</td>
<td style="text-align: right;">0.77</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">374</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">124</td>
<td style="text-align: right;">230</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="identifying-clusters-via-principal-components-analysis" class="level2" data-number="17.8">
<h2 data-number="17.8" class="anchored" data-anchor-id="identifying-clusters-via-principal-components-analysis"><span class="header-section-number">17.8</span> Identifying clusters via Principal Components Analysis</h2>
<p>This section conducts a <strong>Principal Component Analysis (PCA)</strong> on the z-scored biomarker panel to explore the underlying structure of the data. It evaluates how much of the overall variation is captured by each principal component and assesses the potential for dimensionality reduction. While all biomarkers were already standardised, PCA was applied with additional scaling for consistency. The output provides insight into the dominant patterns across biomarkers and helps inform multivariate modelling strategies.</p>
<p>First we will normalise all the assays using the median method. In the real world we might want to test this first for each assay as shown above. The summary shows how much of the total variance can be explained by the various principal components.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>df.pca<span class="ot">&lt;-</span><span class="fu">prcomp</span>(dplyr<span class="sc">::</span><span class="fu">select</span>(df_wider,ang_1_z<span class="sc">:</span>trail_z),<span class="at">scale. =</span> T)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>df.pca.summary<span class="ot">&lt;-</span><span class="fu">summary</span>(df.pca)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>df.pca.summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Importance of components:
                          PC1     PC2     PC3     PC4     PC5     PC6     PC7
Standard deviation     1.2912 1.04619 1.02966 1.01153 1.00482 0.97864 0.96362
Proportion of Variance 0.1389 0.09121 0.08835 0.08527 0.08414 0.07981 0.07738
Cumulative Proportion  0.1389 0.23013 0.31848 0.40375 0.48789 0.56770 0.64508
                           PC8     PC9    PC10    PC11    PC12
Standard deviation     0.94969 0.93327 0.92116 0.91541 0.89422
Proportion of Variance 0.07516 0.07258 0.07071 0.06983 0.06664
Cumulative Proportion  0.72024 0.79282 0.86353 0.93336 1.00000</code></pre>
</div>
</div>
<p>This can be visualised by plotting:</p>
<ul>
<li><p><strong>Proportion of variance</strong> explained by each principal component (PC), showing how much unique information each PC contributes.</p></li>
<li><p><strong>Cumulative variance</strong> explained, helping to assess how many components are needed to retain most of the dataset’s variability.</p></li>
</ul>
<p>Together, these plots inform decisions on dimensionality reduction—e.g., whether a smaller number of components could summarise the variance of the biomarker panel effectively.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df.importance<span class="ot">&lt;-</span><span class="fu">tibble</span>(<span class="at">pc =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(df.pca.summary<span class="sc">$</span>importance[<span class="dv">1</span>,]),</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">standard.deviation =</span> df.pca.summary<span class="sc">$</span>importance[<span class="dv">1</span>,],</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">prop.of.variance =</span> df.pca.summary<span class="sc">$</span>importance[<span class="dv">2</span>,],</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">cumulative.variance =</span> df.pca.summary<span class="sc">$</span>importance[<span class="dv">3</span>,]</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df.importance,<span class="fu">aes</span>(pc,prop.of.variance))<span class="sc">+</span><span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df.importance,<span class="fu">aes</span>(pc,cumulative.variance))<span class="sc">+</span><span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
<p>It looks like only a little of the variance (~15%) is explained by the first principal component. This is probably unsurprising given that the data are simulated and don’t have any real patterns encoded. Further analysis can be made easier by adding the PC data back to the main data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>df_wider<span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(df_wider,<span class="fu">as.data.frame</span>(df.pca<span class="sc">$</span>x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This PCA biplot shows the distribution of specimens across the first two principal components (PC1 and PC2), with points coloured and shaped by outcome (<code>dead_or_alive</code>).</p>
<ul>
<li><p><strong>PC1 explains 13.9%</strong> and <strong>PC2 explains 9%</strong> of the total variance, together capturing just 23% (See above)</p></li>
<li><p>Each point represents a specimen based on its transformed cytokine profile (z-scores).</p></li>
<li><p><strong>Ellipses</strong> represent the 95% confidence regions for each class.</p></li>
<li><p>There is <strong>substantial overlap</strong> between the alive and dead groups, though some separation is visible along both PC1, suggesting mild discriminatory power from the composite cytokine signature.</p></li>
</ul>
<p>This view complements the univariate analyses by illustrating how cytokine expression patterns cluster across outcome groups in multivariate space.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_wider,<span class="fu">aes</span>(PC1,PC2,<span class="at">color=</span>dead_or_alive,<span class="at">label=</span>sample,<span class="at">pch=</span>dead_or_alive))<span class="sc">+</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.4</span>,<span class="at">size=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="at">geom=</span><span class="st">"polygon"</span>, <span class="fu">aes</span>(<span class="at">fill =</span> dead_or_alive), <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">level =</span> <span class="fl">0.95</span>)<span class="sc">+</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="at">label =</span> <span class="fu">str_c</span>(<span class="st">"PC1 ("</span>,<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>df.importance<span class="sc">$</span>prop.of.variance[<span class="dv">1</span>],<span class="dv">2</span>),<span class="st">" %)"</span>,<span class="at">sep =</span> <span class="st">""</span>))<span class="sc">+</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="at">label =</span> <span class="fu">str_c</span>(<span class="st">"PC2 ("</span>,<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>df.importance<span class="sc">$</span>prop.of.variance[<span class="dv">2</span>],<span class="dv">2</span>),<span class="st">" %)"</span>,<span class="at">sep =</span> <span class="st">""</span>))<span class="sc">+</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">aspect.ratio=</span>df.importance<span class="sc">$</span>prop.of.variance[<span class="dv">2</span>]<span class="sc">/</span>df.importance<span class="sc">$</span>prop.of.variance[<span class="dv">1</span>],</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
<section id="linear-regression-to-identify-prognostic-principal-components" class="level3" data-number="17.8.1">
<h3 data-number="17.8.1" class="anchored" data-anchor-id="linear-regression-to-identify-prognostic-principal-components"><span class="header-section-number">17.8.1</span> Linear Regression to identify prognostic Principal Components</h3>
<p>A logistic regression can be fitted using the first 12 principal components (PC1–PC12) as predictors of mortality (<code>dead_or_alive</code>), aiming to identify components carrying diagnostic or prognostic signal.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(<span class="at">data =</span> df_wider,<span class="at">formula =</span> dead_or_alive <span class="sc">~</span> PC1<span class="sc">+</span>PC2<span class="sc">+</span>PC3<span class="sc">+</span>PC4<span class="sc">+</span>PC5<span class="sc">+</span>PC6<span class="sc">+</span>PC7<span class="sc">+</span>PC8<span class="sc">+</span>PC9<span class="sc">+</span>PC10<span class="sc">+</span>PC11<span class="sc">+</span>PC12,<span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = dead_or_alive ~ PC1 + PC2 + PC3 + PC4 + PC5 + PC6 + 
    PC7 + PC8 + PC9 + PC10 + PC11 + PC12, family = "binomial", 
    data = df_wider)

Coefficients:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -0.093126   0.058758  -1.585  0.11299    
PC1          0.244995   0.046261   5.296 1.18e-07 ***
PC2         -0.663058   0.062068 -10.683  &lt; 2e-16 ***
PC3          0.139522   0.057400   2.431  0.01507 *  
PC4          0.256308   0.058335   4.394 1.11e-05 ***
PC5         -0.332554   0.059151  -5.622 1.89e-08 ***
PC6         -0.721157   0.065909 -10.942  &lt; 2e-16 ***
PC7          0.002681   0.061186   0.044  0.96506    
PC8         -0.014150   0.062224  -0.227  0.82012    
PC9         -0.174818   0.063749  -2.742  0.00610 ** 
PC10         0.037276   0.063781   0.584  0.55892    
PC11        -0.207031   0.065107  -3.180  0.00147 ** 
PC12        -0.452560   0.068142  -6.641 3.11e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 2103.0  on 1519  degrees of freedom
Residual deviance: 1726.4  on 1507  degrees of freedom
AIC: 1752.4

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p><strong>Model findings:</strong></p>
<ul>
<li><p>The model explains substantial variation in the outcome (AIC = 2827.1, reduced from the null model’s 3100.8).</p></li>
<li><p><strong>Statistically significant PCs</strong>:</p>
<ul>
<li><strong>PC1</strong>, <strong>PC2</strong>, <strong>PC4</strong>, <strong>PC5</strong>, <strong>PC6</strong> and <strong>PC12</strong> showed significant associations (<em>p</em> &lt; 1e-5).</li>
</ul></li>
<li><p><strong>Most influential components</strong>:</p>
<ul>
<li><strong>PC2 and PC6</strong> show strong negative associations, potentially identifying protective biomarkers</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_wider,<span class="fu">aes</span>(PC2,PC6,<span class="at">color=</span>dead_or_alive,<span class="at">label=</span>sample,<span class="at">pch=</span>dead_or_alive))<span class="sc">+</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.4</span>,<span class="at">size=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="at">geom=</span><span class="st">"polygon"</span>, <span class="fu">aes</span>(<span class="at">fill =</span> dead_or_alive), <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">level =</span> <span class="fl">0.95</span>)<span class="sc">+</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="at">label =</span> <span class="fu">str_c</span>(<span class="st">"PC2 ("</span>,<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>df.importance<span class="sc">$</span>prop.of.variance[<span class="dv">2</span>],<span class="dv">2</span>),<span class="st">" %)"</span>,<span class="at">sep =</span> <span class="st">""</span>))<span class="sc">+</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="at">label =</span> <span class="fu">str_c</span>(<span class="st">"PC6 ("</span>,<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>df.importance<span class="sc">$</span>prop.of.variance[<span class="dv">6</span>],<span class="dv">2</span>),<span class="st">" %)"</span>,<span class="at">sep =</span> <span class="st">""</span>))<span class="sc">+</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">aspect.ratio=</span>df.importance<span class="sc">$</span>prop.of.variance[<span class="dv">2</span>]<span class="sc">/</span>df.importance<span class="sc">$</span>prop.of.variance[<span class="dv">1</span>],</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
<p>These results suggest that multiple PCs contain diagnostically useful signal, and that unsupervised dimensionality reduction preserves meaningful information relevant to mortality classification.</p>
</section>
<section id="interpreting-pcs-with-loadings-plots" class="level3" data-number="17.8.2">
<h3 data-number="17.8.2" class="anchored" data-anchor-id="interpreting-pcs-with-loadings-plots"><span class="header-section-number">17.8.2</span> Interpreting PCs with loadings plots</h3>
<p>To understand what each principal component represents, loadings plots are generated. These show how strongly each original biomarker contributes to a given principal component.</p>
<ul>
<li><p><strong>PC1 Loadings</strong>: This component captures the dominant pattern of variance across the biomarker panel. Large positive or negative loadings indicate biomarkers that are highly correlated with this axis.</p></li>
<li><p><strong>PC4 Loadings</strong>: Although less dominant in variance explained, PC4 was strongly associated with mortality in the regression model. Loadings for PC4 help identify which specific biomarkers drive this mortality-associated axis.</p></li>
</ul>
<p>By plotting the <strong>rotation matrix</strong> (PCA loadings), we visually inspect which biomarkers are most influential in each component. This guides interpretation of biological or diagnostic relevance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df.pca <span class="sc">%&gt;%</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tidy</span>(<span class="at">matrix =</span> <span class="st">"rotation"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(PC<span class="sc">==</span><span class="st">"2"</span> <span class="sc">|</span> PC<span class="sc">==</span><span class="st">"6"</span>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(column,value)) <span class="sc">+</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(PC<span class="sc">~</span>.)<span class="sc">+</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><p>The bars pointing left or right show the relative contribution of that biomarker to either the positive (rightward) or negative (leftward) values of the PC.</p></li>
<li><p>Important to remember that PCA space you can flip the axis 180° without changing the underlying geometry, so “positive” vs “negative” loadings don’t carry any inherent meaning. What matters are the relative magnitudes of the loadings and the pattern of which variables move together or in opposition, not whether they’re plotted above or below zero.</p></li>
<li><p>Remember that this is a simulated data set, so these patterns are also not real.</p></li>
</ul>
</section>
<section id="roc-analysis-of-pc-associations-with-outcomes" class="level3" data-number="17.8.3">
<h3 data-number="17.8.3" class="anchored" data-anchor-id="roc-analysis-of-pc-associations-with-outcomes"><span class="header-section-number">17.8.3</span> ROC analysis of PC associations with outcomes</h3>
<p>You can also use PCs as the input to a ROC analysis.</p>
<p>In this case, a multi-marker test fails to improve on a single marker test - Again please remember that this is a simulated clinical data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ROCit_plot</span>(<span class="at">data=</span>df_wider,<span class="at">score_col =</span> <span class="st">"PC1"</span>,<span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>,<span class="at">color =</span> <span class="st">"#000000"</span>)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"PC1"</span>) <span class="sc">+</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ROCit_plot</span>(<span class="at">data=</span>df_wider,<span class="at">score_col =</span> <span class="st">"PC4"</span>,<span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>,<span class="at">color =</span> <span class="st">"#000000"</span>)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"PC4"</span>) <span class="sc">+</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ROCit_plot</span>(<span class="at">data=</span>df_wider,<span class="at">score_col =</span> <span class="st">"PC8"</span>,<span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>,<span class="at">color =</span> <span class="st">"#000000"</span>)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"PC8"</span>) <span class="sc">+</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROCit_plot</span>(<span class="at">data=</span>df_wider,<span class="at">score_col =</span> <span class="st">"PC5"</span>,<span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>,<span class="at">color =</span> <span class="st">"#000000"</span>,<span class="at">negate_score =</span> T)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"PC5"</span>) <span class="sc">+</span>  </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ROCit_plot</span>(<span class="at">data=</span>df_wider,<span class="at">score_col =</span> <span class="st">"PC9"</span>,<span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>,<span class="at">color =</span> <span class="st">"#000000"</span>,<span class="at">negate_score =</span> T)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"PC9"</span>) <span class="sc">+</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROCit_plot</span>(<span class="at">data=</span>df_wider,<span class="at">score_col =</span> <span class="st">"PC11"</span>,<span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>,<span class="at">color =</span> <span class="st">"#000000"</span>)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"PC11"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="mahalanobis-distance-for-outlier-detection-or-risk-scoring" class="level3" data-number="17.8.4">
<h3 data-number="17.8.4" class="anchored" data-anchor-id="mahalanobis-distance-for-outlier-detection-or-risk-scoring"><span class="header-section-number">17.8.4</span> <strong>Mahalanobis Distance for Outlier Detection or Risk Scoring</strong></h3>
<p>This approach explores <strong>profile-wide variance</strong> in the PCA space to identify individuals whose overall biomarker profile deviates from the “normal” (control) pattern.</p>
<p>We compute a <strong>Mahalanobis distance</strong> for each sample, quantifying how far its position in PCA space lies from the centroid of the “Alive” group (i.e., survivors). This reflects multivariate deviation across all principal components.</p>
<section id="method" class="level4" data-number="17.8.4.1">
<h4 data-number="17.8.4.1" class="anchored" data-anchor-id="method"><span class="header-section-number">17.8.4.1</span> Method:</h4>
<ul>
<li><p><strong>Controls</strong>: Used only the <code>Alive</code> group to compute:</p>
<ul>
<li><p>The <strong>centroid</strong> (mean vector of PCs).</p></li>
<li><p>The <strong>covariance matrix</strong> of PCs.</p></li>
</ul></li>
<li><p><strong>All samples</strong>: Computed Mahalanobis distance from that centroid using:</p>
<p><span class="math display">\[D^2 = (x - \mu)^\top \Sigma^{-1} (x - \mu)\]</span></p>
<p>where:</p>
<p>x is the PC vector for an individual sample,</p>
<p>μ is the control (Alive) group mean vector</p>
<p>Σ is the covariance matrix of controls.</p></li>
<li><p>This can now act as a <strong>multivariate anomaly score</strong>, potentially highlighting high-risk profiles.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute covariance matrix of controls</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>control_pca <span class="ot">&lt;-</span> df_wider <span class="sc">%&gt;%</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dead_or_alive <span class="sc">==</span> <span class="st">"Alive"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"PC"</span>))</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>cov_matrix <span class="ot">&lt;-</span> <span class="fu">cov</span>(control_pca, <span class="at">use =</span> <span class="st">"complete.obs"</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute Mahalanobis distance from control centroid</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>df_wider <span class="ot">&lt;-</span> df_wider <span class="sc">%&gt;%</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mahalanobis_distance =</span> <span class="fu">mahalanobis</span>(<span class="fu">select</span>(., <span class="fu">starts_with</span>(<span class="st">"PC"</span>)), <span class="fu">colMeans</span>(control_pca, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), cov_matrix))</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_wider, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(mahalanobis_distance), <span class="at">fill =</span> dead_or_alive)) <span class="sc">+</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Distance from Control Centroid in PCA Space"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
<p>To assess its predictive utility, you might plot a ROC curve</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ROCit_plot</span>(<span class="at">data=</span>df_wider,<span class="at">score_col =</span> <span class="st">"mahalanobis_distance"</span>,<span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>,<span class="at">color =</span> <span class="st">"#000000"</span>)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"mahalanobis_distance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
<p>and also fit a logistic regression</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">glm</span>(dead_or_alive <span class="sc">~</span> <span class="fu">log</span>(mahalanobis_distance), <span class="at">data =</span> df_wider, <span class="at">family =</span> <span class="st">"binomial"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = dead_or_alive ~ log(mahalanobis_distance), family = "binomial", 
    data = df_wider)

Coefficients:
                          Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)               -2.02252    0.23384  -8.649   &lt;2e-16 ***
log(mahalanobis_distance)  0.78761    0.09354   8.420   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 2103.0  on 1519  degrees of freedom
Residual deviance: 2025.9  on 1518  degrees of freedom
AIC: 2029.9

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="marker-importance-and-selection" class="level2" data-number="17.9">
<h2 data-number="17.9" class="anchored" data-anchor-id="marker-importance-and-selection"><span class="header-section-number">17.9</span> Marker Importance and Selection</h2>
<p>So far, we’ve explored both <strong>individual biomarker effects</strong> and <strong>composite multivariate structures</strong> (e.g.&nbsp;via PCA and Mahalanobis distance) for predicting mortality. While informative, these approaches do not explicitly rank biomarkers by their <strong>predictive relevance</strong>.</p>
<p>To refine the model and move toward a <strong>parsimonious and interpretable diagnostic signature</strong>, we next assess:</p>
<ol type="1">
<li><p><strong>Which markers contribute most to predictive performance?</strong></p></li>
<li><p><strong>Which subset of markers can be used without sacrificing accuracy?</strong></p></li>
</ol>
<p>This step focuses on <strong>feature importance</strong> and <strong>selection</strong>, key concepts in diagnostic biomarker development and model generalisation.</p>
<section id="variable-selection" class="level3" data-number="17.9.1">
<h3 data-number="17.9.1" class="anchored" data-anchor-id="variable-selection"><span class="header-section-number">17.9.1</span> Variable Selection</h3>
<p>The justification for a variable selection approach is that it:</p>
<ul>
<li><p>Reduces overfitting and improves generalisability</p></li>
<li><p>Lowers cost and complexity for downstream assays</p></li>
<li><p>Enhances interpretability and potential biological insight</p></li>
</ul>
</section>
<section id="approaches-used-for-variable-selection" class="level3" data-number="17.9.2">
<h3 data-number="17.9.2" class="anchored" data-anchor-id="approaches-used-for-variable-selection"><span class="header-section-number">17.9.2</span> Approaches Used for variable selection</h3>
<p>We apply two complementary techniques:</p>
<section id="boruta-feature-selection" class="level4" data-number="17.9.2.1">
<h4 data-number="17.9.2.1" class="anchored" data-anchor-id="boruta-feature-selection"><span class="header-section-number">17.9.2.1</span> 1. <strong>Boruta Feature Selection</strong></h4>
<ul>
<li><p>A <em>wrapper algorithm</em> built around random forests.</p></li>
<li><p>Compares original variables to their permuted (shadow) counterparts.</p></li>
<li><p>Retains variables that show consistently higher importance than the best random feature.</p></li>
<li><p>Well suited for <strong>highly-dimensional and noisy data</strong>.</p></li>
</ul>
</section>
<section id="recursive-feature-elimination-rfe" class="level4" data-number="17.9.2.2">
<h4 data-number="17.9.2.2" class="anchored" data-anchor-id="recursive-feature-elimination-rfe"><span class="header-section-number">17.9.2.2</span> 2. <strong>Recursive Feature Elimination (RFE)</strong></h4>
<ul>
<li><p>A <em>greedy backward selection</em> method.</p></li>
<li><p>Iteratively removes the <strong>least important</strong> features based on model weight (e.g., in logistic regression or random forest).</p></li>
<li><p>Efficient in identifying a minimal <strong>optimal feature subset</strong>.</p></li>
</ul>
</section>
</section>
<section id="enhancing-clinical-relevance-adding-demographic-and-clinical-variables" class="level3" data-number="17.9.3">
<h3 data-number="17.9.3" class="anchored" data-anchor-id="enhancing-clinical-relevance-adding-demographic-and-clinical-variables"><span class="header-section-number">17.9.3</span> Enhancing Clinical Relevance: Adding Demographic and Clinical Variables</h3>
<p>To reflect more practical diagnostic settings, we extended the dataset to include additional <strong>demographic and clinical predictors</strong>:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 31%">
<col style="width: 68%">
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>sex</code></td>
<td>Randomly assigned binary variable (Male/Female), ~50:50 split</td>
</tr>
<tr class="even">
<td><code>age</code></td>
<td>Uniformly distributed between 18 and 87</td>
</tr>
<tr class="odd">
<td><code>temp</code></td>
<td>Simulated body temperature, slightly elevated in patients who died</td>
</tr>
<tr class="even">
<td><code>respiratory_rate</code></td>
<td>Skewed towards higher values in the <code>Dead</code> group to reflect increased physiological stress</td>
</tr>
</tbody>
</table>
<p>These variables complement the biomarker panels and allow exploration of <strong>combined models</strong> that integrate <strong>clinical indicators with molecular signatures</strong>.</p>
<p>One of the strengths of <strong>Boruta</strong> and <strong>Random Forest</strong>-based approaches lies in their ability to handle a <strong>plurality of variable types</strong>. This includes:</p>
<ul>
<li><p><strong>Continuous variables</strong> (e.g.&nbsp;cytokine Z-scores, temperature, age)</p></li>
<li><p><strong>Categorical/factor variables</strong> (e.g.&nbsp;sex, HIV status)</p></li>
</ul>
<p>This flexibility makes these methods particularly well-suited for real-world clinical data, where predictive models often need to integrate <strong>biological markers, demographic traits, and physiological indicators</strong> in a unified framework without requiring extensive pre-processing or transformation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>df_wider <span class="ot">&lt;-</span> df_wider <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sex: 50/50 Male/Female</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">sex =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Male"</span>, <span class="st">"Female"</span>), <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Age: uniformly between 18 and 87</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">sample</span>(<span class="dv">18</span><span class="sc">:</span><span class="dv">87</span>, <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Temperature: higher in Dead group</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">temp =</span> <span class="fu">case_when</span>(</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>      dead_or_alive <span class="sc">==</span> <span class="st">"Alive"</span> <span class="sc">~</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="at">mean =</span> <span class="fl">37.2</span>, <span class="at">sd =</span> <span class="fl">0.4</span>), <span class="fl">36.2</span>), <span class="fl">40.3</span>),</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>      dead_or_alive <span class="sc">==</span> <span class="st">"Dead"</span>  <span class="sc">~</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="at">mean =</span> <span class="fl">37.7</span>, <span class="at">sd =</span> <span class="fl">0.5</span>), <span class="fl">36.2</span>), <span class="fl">40.3</span>)</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Respiratory rate: skewed lower in Alive, higher but still rare in Dead</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">respiratory_rate =</span> <span class="fu">case_when</span>(</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>      dead_or_alive <span class="sc">==</span> <span class="st">"Alive"</span> <span class="sc">~</span> <span class="fu">round</span>(<span class="fu">pmin</span>(<span class="fu">rbeta</span>(<span class="fu">n</span>(), <span class="dv">2</span>, <span class="dv">10</span>) <span class="sc">*</span> <span class="dv">45</span> <span class="sc">+</span> <span class="dv">25</span>, <span class="dv">70</span>)),</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>      dead_or_alive <span class="sc">==</span> <span class="st">"Dead"</span>  <span class="sc">~</span> <span class="fu">round</span>(<span class="fu">pmin</span>(<span class="fu">rbeta</span>(<span class="fu">n</span>(), <span class="dv">3</span>, <span class="dv">11</span>) <span class="sc">*</span> <span class="dv">45</span> <span class="sc">+</span> <span class="dv">25</span>, <span class="dv">70</span>))</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="boruta-analysis" class="level3" data-number="17.9.4">
<h3 data-number="17.9.4" class="anchored" data-anchor-id="boruta-analysis"><span class="header-section-number">17.9.4</span> Boruta Analysis</h3>
<p>This chunk initiates a <strong>Boruta</strong> variable selection process to identify important predictors of mortality (<code>dead_or_alive</code>) using a <strong>wrapper around random forests</strong>.</p>
<ul>
<li><p><strong>Included variables</strong>: A mix of biomarkers (e.g.&nbsp;<code>ang_1</code>, <code>il_8</code>, <code>trail</code>), demographic (<code>age</code>, <code>sex</code>), and clinical measures (<code>temp</code>, <code>respiratory_rate</code>, <code>hiv_comb</code>).</p></li>
<li><p><strong>Strength</strong>: Boruta can handle both <strong>continuous</strong> and <strong>categorical</strong> predictors.</p></li>
<li><p><strong>Outcome</strong>: It returns a ranking of features as <em>Confirmed</em>, <em>Tentative</em>, or <em>Rejected</em> based on importance relative to shadow variables.</p></li>
</ul>
<p>This sets the stage for rigorous <strong>feature importance analysis</strong>, considering both biological and clinical context.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#BORUTA</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1232131</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>boruta.train <span class="ot">&lt;-</span> <span class="fu">Boruta</span>(dead_or_alive <span class="sc">~</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  ang_1<span class="sc">+</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  ang_2<span class="sc">+</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  azu<span class="sc">+</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  ch3l1<span class="sc">+</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  il_10<span class="sc">+</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  il_6<span class="sc">+</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  il_8<span class="sc">+</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  ip_10<span class="sc">+</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  mxa<span class="sc">+</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  stnf_r1<span class="sc">+</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  strem1<span class="sc">+</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  trail<span class="sc">+</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>  hiv_comb<span class="sc">+</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  sex<span class="sc">+</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  age<span class="sc">+</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>  temp<span class="sc">+</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>  respiratory_rate,</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> df_wider, <span class="at">doTrace =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The output of <code>print(boruta.train)</code> will look something like this</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(boruta.train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Boruta performed 58 iterations in 27.42112 secs.
 6 attributes confirmed important: ch3l1, hiv_comb, il_8, mxa,
respiratory_rate and 1 more;
 11 attributes confirmed unimportant: age, ang_1, ang_2, azu, il_10 and
6 more;</code></pre>
</div>
</div>
<ul>
<li><p><strong>Confirmed important</strong>: Variables that were consistently more important than the best shadow (random) variable, indicating strong predictive value.<br>
Includes several cytokines and all added demographic/clinical variables.</p></li>
<li><p><strong>Confirmed unimportant</strong>: Variables with performance consistently worse than or comparable to noise—likely not informative in this model.</p></li>
<li><p><strong>Tentative</strong>: (If present) variables that require further resolution using <code>TentativeRoughFix()</code> or similar post-processing.</p></li>
</ul>
<p>After running <code>TentativeRoughFix()</code>, <strong>Boruta finalises decisions for previously “tentative” variables</strong> by reassessing their importance using the <strong>median</strong> rather than the <strong>mean</strong> importance. This approach helps resolve ambiguous cases by reducing the influence of skewed distributions or outliers, often leading to a clearer classification as either <em>confirmed</em> or <em>rejected</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1232131</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>final.boruta <span class="ot">&lt;-</span> <span class="fu">TentativeRoughFix</span>(boruta.train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in TentativeRoughFix(boruta.train): There are no Tentative attributes!
Returning original object.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final.boruta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Boruta performed 58 iterations in 27.42112 secs.
 6 attributes confirmed important: ch3l1, hiv_comb, il_8, mxa,
respiratory_rate and 1 more;
 11 attributes confirmed unimportant: age, ang_1, ang_2, azu, il_10 and
6 more;</code></pre>
</div>
</div>
<p>This chunk extracts and ranks the variable importance results from the finalised Boruta model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>boruta.df <span class="ot">&lt;-</span> <span class="fu">attStats</span>(final.boruta)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>boruta.df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">marker =</span> <span class="fu">rownames</span>(.)) <span class="sc">%&gt;%</span> <span class="fu">select</span> (marker, <span class="fu">everything</span>())  <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="sc">-</span>meanImp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                           marker     meanImp   medianImp     minImp
temp                         temp 64.23040355 65.85575753 51.4601672
il_8                         il_8 41.35344492 42.04428610 31.4291703
mxa                           mxa 26.34929291 27.01609627 20.6327883
hiv_comb                 hiv_comb 22.56907230 23.76874268 15.5292412
respiratory_rate respiratory_rate 18.98502149 19.08442753 14.8500932
ch3l1                       ch3l1 15.70375900 15.80021514 11.5464317
stnf_r1                   stnf_r1  1.14679355  1.03330312 -1.3285477
strem1                     strem1  0.92215204  0.78664909 -1.7265029
azu                           azu  0.89763240  0.94523612 -1.7968908
ang_2                       ang_2  0.75928496  0.72231259 -2.1193519
trail                       trail  0.54013142  0.25399909 -0.4974893
age                           age  0.51412678  0.32117635 -0.7481246
ang_1                       ang_1  0.47594421  0.09520428 -1.9640355
il_10                       il_10  0.16327495  0.34528929 -1.4862504
ip_10                       ip_10 -0.01707495 -0.12250408 -1.0176148
sex                           sex -0.03927419 -0.10068697 -2.1891422
il_6                         il_6 -1.07400295 -0.77405886 -2.4674168
                       maxImp   normHits  decision
temp             73.489578810 1.00000000 Confirmed
il_8             49.598603240 1.00000000 Confirmed
mxa              29.312988700 1.00000000 Confirmed
hiv_comb         28.393989871 1.00000000 Confirmed
respiratory_rate 23.952158193 1.00000000 Confirmed
ch3l1            19.039376151 1.00000000 Confirmed
stnf_r1           3.196259969 0.22413793  Rejected
strem1            4.200867701 0.22413793  Rejected
azu               3.419481523 0.27586207  Rejected
ang_2             3.009769641 0.06896552  Rejected
trail             2.014600507 0.00000000  Rejected
age               1.777077005 0.00000000  Rejected
ang_1             4.221019066 0.01724138  Rejected
il_10             1.404145906 0.00000000  Rejected
ip_10             2.164345250 0.00000000  Rejected
sex               1.667814589 0.03448276  Rejected
il_6              0.006263453 0.00000000  Rejected</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(boruta.df,<span class="at">digits =</span> <span class="dv">2</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 25%">
<col style="width: 11%">
<col style="width: 14%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 13%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">meanImp</th>
<th style="text-align: right;">medianImp</th>
<th style="text-align: right;">minImp</th>
<th style="text-align: right;">maxImp</th>
<th style="text-align: right;">normHits</th>
<th style="text-align: left;">decision</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">respiratory_rate</td>
<td style="text-align: right;">18.99</td>
<td style="text-align: right;">19.08</td>
<td style="text-align: right;">14.85</td>
<td style="text-align: right;">23.95</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">Confirmed</td>
</tr>
<tr class="even">
<td style="text-align: left;">temp</td>
<td style="text-align: right;">64.23</td>
<td style="text-align: right;">65.86</td>
<td style="text-align: right;">51.46</td>
<td style="text-align: right;">73.49</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">Confirmed</td>
</tr>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">0.51</td>
<td style="text-align: right;">0.32</td>
<td style="text-align: right;">-0.75</td>
<td style="text-align: right;">1.78</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: left;">Rejected</td>
</tr>
<tr class="even">
<td style="text-align: left;">sex</td>
<td style="text-align: right;">-0.04</td>
<td style="text-align: right;">-0.10</td>
<td style="text-align: right;">-2.19</td>
<td style="text-align: right;">1.67</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: left;">Rejected</td>
</tr>
<tr class="odd">
<td style="text-align: left;">hiv_comb</td>
<td style="text-align: right;">22.57</td>
<td style="text-align: right;">23.77</td>
<td style="text-align: right;">15.53</td>
<td style="text-align: right;">28.39</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">Confirmed</td>
</tr>
<tr class="even">
<td style="text-align: left;">trail</td>
<td style="text-align: right;">0.54</td>
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">-0.50</td>
<td style="text-align: right;">2.01</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: left;">Rejected</td>
</tr>
<tr class="odd">
<td style="text-align: left;">strem1</td>
<td style="text-align: right;">0.92</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">-1.73</td>
<td style="text-align: right;">4.20</td>
<td style="text-align: right;">0.22</td>
<td style="text-align: left;">Rejected</td>
</tr>
<tr class="even">
<td style="text-align: left;">stnf_r1</td>
<td style="text-align: right;">1.15</td>
<td style="text-align: right;">1.03</td>
<td style="text-align: right;">-1.33</td>
<td style="text-align: right;">3.20</td>
<td style="text-align: right;">0.22</td>
<td style="text-align: left;">Rejected</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mxa</td>
<td style="text-align: right;">26.35</td>
<td style="text-align: right;">27.02</td>
<td style="text-align: right;">20.63</td>
<td style="text-align: right;">29.31</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">Confirmed</td>
</tr>
<tr class="even">
<td style="text-align: left;">ip_10</td>
<td style="text-align: right;">-0.02</td>
<td style="text-align: right;">-0.12</td>
<td style="text-align: right;">-1.02</td>
<td style="text-align: right;">2.16</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: left;">Rejected</td>
</tr>
<tr class="odd">
<td style="text-align: left;">il_8</td>
<td style="text-align: right;">41.35</td>
<td style="text-align: right;">42.04</td>
<td style="text-align: right;">31.43</td>
<td style="text-align: right;">49.60</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">Confirmed</td>
</tr>
<tr class="even">
<td style="text-align: left;">il_6</td>
<td style="text-align: right;">-1.07</td>
<td style="text-align: right;">-0.77</td>
<td style="text-align: right;">-2.47</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: left;">Rejected</td>
</tr>
<tr class="odd">
<td style="text-align: left;">il_10</td>
<td style="text-align: right;">0.16</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">-1.49</td>
<td style="text-align: right;">1.40</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: left;">Rejected</td>
</tr>
<tr class="even">
<td style="text-align: left;">ch3l1</td>
<td style="text-align: right;">15.70</td>
<td style="text-align: right;">15.80</td>
<td style="text-align: right;">11.55</td>
<td style="text-align: right;">19.04</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">Confirmed</td>
</tr>
<tr class="odd">
<td style="text-align: left;">azu</td>
<td style="text-align: right;">0.90</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">-1.80</td>
<td style="text-align: right;">3.42</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: left;">Rejected</td>
</tr>
<tr class="even">
<td style="text-align: left;">ang_2</td>
<td style="text-align: right;">0.76</td>
<td style="text-align: right;">0.72</td>
<td style="text-align: right;">-2.12</td>
<td style="text-align: right;">3.01</td>
<td style="text-align: right;">0.07</td>
<td style="text-align: left;">Rejected</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ang_1</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">-1.96</td>
<td style="text-align: right;">4.22</td>
<td style="text-align: right;">0.02</td>
<td style="text-align: left;">Rejected</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li><p>The table includes:</p>
<ul>
<li><p><code>meanImp</code>: mean importance across iterations.</p></li>
<li><p><code>medianImp</code>: median importance.</p></li>
<li><p><code>decision</code>: final call by Boruta (<em>Confirmed</em>, <em>Rejected</em>, or previously <em>Tentative</em>).</p></li>
</ul></li>
</ul>
<p>This provides a clear and interpretable ranking of predictors contributing to classification performance.</p>
<section id="boruta-variables-confirmed-chart" class="level4" data-number="17.9.4.1">
<h4 data-number="17.9.4.1" class="anchored" data-anchor-id="boruta-variables-confirmed-chart"><span class="header-section-number">17.9.4.1</span> Boruta Variables Confirmed Chart</h4>
<p>This chunk creates a visual summary of how consistently important each variable was across random forest iterations, with statistical robustness reflected in the spread and medians of their boxplots. This allows intuitive inspection of variable reliability and influence.</p>
<p>Some calculations have to be done for this</p>
<ul>
<li><p><strong>Extracts raw importance history</strong> from the Boruta model (<code>ImpHistory</code>), storing importance scores across iterations.</p></li>
<li><p><strong>Transforms data to long format</strong> using <code>pivot_longer()</code>, with one row per (marker, iteration) pair.</p></li>
<li><p><strong>Adds final decisions</strong> (<code>Confirmed</code>, <code>Rejected</code>, <code>Tentative</code>) by joining with <code>finalDecision</code>.</p></li>
<li><p><strong>Calculates marker-wise median importance</strong> to guide ordering in the plot.</p></li>
<li><p><strong>Creates a boxplot</strong> of importance scores per marker, coloured by Boruta’s decision.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>boruta.imp<span class="ot">&lt;-</span><span class="fu">as_tibble</span>(final.boruta<span class="sc">$</span>ImpHistory, <span class="at">.name_repair =</span> <span class="st">"minimal"</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>boruta.imp<span class="ot">&lt;-</span>boruta.imp<span class="sc">%&gt;%</span> </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">13</span>,<span class="at">names_to =</span> <span class="st">"marker"</span>,<span class="at">values_to =</span> <span class="st">"importance"</span>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>final_decision_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">marker =</span> <span class="fu">names</span>(final.boruta<span class="sc">$</span>finalDecision),</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">decision =</span> final.boruta<span class="sc">$</span>finalDecision</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>boruta.imp <span class="ot">&lt;-</span> boruta.imp <span class="sc">%&gt;%</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(final_decision_tbl, <span class="at">by =</span> <span class="st">"marker"</span>)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>boruta.imp <span class="sc">%&gt;%</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(marker) <span class="sc">%&gt;%</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">median_imp =</span> <span class="fu">median</span>(importance, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">marker =</span> <span class="fu">fct_reorder</span>(marker, median_imp)) <span class="sc">%&gt;%</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> marker, <span class="at">y =</span> importance,<span class="at">fill=</span>decision)) <span class="sc">+</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="recursive-feature-elimination-rfe-on-boruta-selected-variables" class="level4" data-number="17.9.4.2">
<h4 data-number="17.9.4.2" class="anchored" data-anchor-id="recursive-feature-elimination-rfe-on-boruta-selected-variables"><span class="header-section-number">17.9.4.2</span> Recursive Feature Elimination (RFE) on Boruta-selected variables</h4>
<p>This chunk applies <strong>Recursive Feature Elimination (RFE)</strong> to the <strong>Boruta-confirmed variables</strong> to identify the most parsimonious subset of predictors for classifying mortality (<code>dead_or_alive</code>).</p>
<p>This step complements Boruta by ranking the predictive power of confirmed features and identifying a minimal, high-performing subset <strong>through repeated cross-validation</strong>, which ensures that feature selection is robust to sampling variation and generalises well to unseen data.</p>
<p>Here, we also implement <strong>Parallel computing</strong> by dynamically detecting available CPU cores and registering a parallel backend to speed up RFE. It’s possible to run RFE without parallel approaches, but it will take longer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1232131</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the confirmed variables list from Boruta</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>confirmed_vars <span class="ot">&lt;-</span> <span class="fu">getSelectedAttributes</span>(final.boruta, <span class="at">withTentative =</span> <span class="cn">FALSE</span>)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset to only Boruta-confirmed vars</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>df_wider_rfe <span class="ot">&lt;-</span> df_wider <span class="sc">%&gt;%</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(confirmed_vars),dead_or_alive)</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Detect available cores and reserve 1–2 for the OS</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>n_cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(n_cores)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Set parameters for RFE</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>control <span class="ot">&lt;-</span> <span class="fu">rfeControl</span>(</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">functions =</span> rfFuncs,</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"cv"</span>,        <span class="co"># or "repeatedcv", "boot", etc.</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">number =</span> <span class="dv">20</span>,           <span class="co"># number of folds - increase this when using real data 10-15 minimum</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">allowParallel =</span> <span class="cn">TRUE</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Run your RFE</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>rfe_result <span class="ot">&lt;-</span> <span class="fu">rfe</span>(</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> df_wider_rfe <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">all_of</span>(<span class="st">"dead_or_alive"</span>)),</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> df_wider_rfe<span class="sc">$</span>dead_or_alive,</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">sizes =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(confirmed_vars), <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">rfeControl =</span> control</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Always stop the cluster afterward</span></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="rfe-results---charts" class="level4" data-number="17.9.4.3">
<h4 data-number="17.9.4.3" class="anchored" data-anchor-id="rfe-results---charts"><span class="header-section-number">17.9.4.3</span> RFE Results - Charts</h4>
<p>This plot visualises the relationship between the number of features selected and the model’s cross-validated accuracy. Each point represents a different subset size tested by RFE, helping to identify the smallest number of predictors that yields near-maximum performance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rfe_result, <span class="fu">aes</span>(Variables, Accuracy)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
<p>This plot illustrates how predictive accuracy varies with the number of selected features, using <strong>cross-validation</strong>.</p>
<ul>
<li><p><strong>Accuracy peaks early</strong> (with just 3–4 variables), then fluctuates slightly as more features are added.</p></li>
<li><p>The <strong>maximum accuracy</strong> hovers around <strong>0.8</strong>, suggesting <strong>diminishing returns</strong> beyond the top few variables.</p></li>
</ul>
<p>This underscores the value of <strong>recursive feature elimination (RFE)</strong> in identifying a <strong>parsimonious biomarker set</strong> that performs nearly as well as the full set. This is critical for developing practical, cost-effective diagnostics.</p>
<p><strong>The accuracy at each point in the RFE plot doesn’t reflect a single fixed model</strong>, but rather the <strong>average performance</strong> across <strong>many different combinations</strong> of variables of that size.</p>
<p>So when the plot shows a peak at 3 variables, it means that:</p>
<ul>
<li><p>The <strong>best-performing 3-variable combinations</strong> achieved that level of accuracy.</p></li>
<li><p>It does <strong>not</strong> imply a single unique 3-marker model, rather it’s a summary of the <strong>cross-validated performance</strong> across all possible subsets of that size, as sampled during RFE.</p></li>
</ul>
<p>This is especially useful for understanding the <strong>information density</strong> of the feature set:</p>
<ul>
<li><p>A few variables already carry most of the predictive power.</p></li>
<li><p>Adding more may help a little, but with diminishing returns.</p></li>
</ul>
<p>To identify which variables perform best in the three variable combinations, you can use this chunk :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(rfe_result<span class="sc">$</span>variables <span class="sc">%&gt;%</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">filter</span>(Variables <span class="sc">==</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">count</span>(var, <span class="at">sort =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">var</th>
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">hiv_comb</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="even">
<td style="text-align: left;">il_8</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mxa</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="even">
<td style="text-align: left;">temp</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">respiratory_rate</td>
<td style="text-align: right;">16</td>
</tr>
<tr class="even">
<td style="text-align: left;">ch3l1</td>
<td style="text-align: right;">4</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This result shows that when selecting <strong>5 variables (just as an example)</strong>, the <strong>RFE</strong> process <strong>consistently</strong> (in all 20 resampling iterations) selected <code>hiv_comb</code>, <code>il_8, MxA</code> and <code>temp</code>, which indicates that these four markers are <strong>robust predictors</strong> of the outcome when the model is constrained to five inputs. In 16 resamplings, the fifth marker was <code>respiratory rate</code> and in the remaining 4, that was replaced with <code>CH3L1</code>. This kind of trade-off can highlight how some markers behave less consistently and may therefore be less robust predictors.</p>
<p>In the model above we can achieve quite high accuracy with a three-marker model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(rfe_result<span class="sc">$</span>variables <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">filter</span>(Variables <span class="sc">==</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">count</span>(var, <span class="at">sort =</span> <span class="cn">TRUE</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">var</th>
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">hiv_comb</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="even">
<td style="text-align: left;">il_8</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">temp</td>
<td style="text-align: right;">20</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Technically this does not imply that this specific trio is the best model, but that they form a core signal under the RFE model.</p>
<p>It’s still highly likely that they will constitute the best model, but In production, you’d still want to evaluate this 3-variable model’s PPV, sensitivity, etc., and potentially validate it on external data. Note that the addition of <code>MxA</code> to create a four-marker model increases the overall accuracy (see RFE results) but how you choose the final model should be conditioned not only on accuracy. For many contexts it may be more useful to look at PPV or NPV.</p>
</section>
<section id="glm-to-confirm-performance-using-a-different-approach" class="level4" data-number="17.9.4.4">
<h4 data-number="17.9.4.4" class="anchored" data-anchor-id="glm-to-confirm-performance-using-a-different-approach"><span class="header-section-number">17.9.4.4</span> GLM to confirm performance using a different approach</h4>
<p>We can use a logistic regression to model the three markers and their associations with the outcome.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>final_2var_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(dead_or_alive <span class="sc">~</span> il_8 <span class="sc">+</span> hiv_comb <span class="sc">+</span> temp ,</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> df_wider, </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">family =</span> binomial)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">summary</span>(final_2var_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = dead_or_alive ~ il_8 + hiv_comb + temp, family = binomial, 
    data = df_wider)

Coefficients:
                     Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)          -90.4099     5.5341 -16.337   &lt;2e-16 ***
il_8                   1.2382     0.1207  10.257   &lt;2e-16 ***
hiv_combHIV_Positive   0.1648     0.1236   1.333    0.183    
temp                   2.3740     0.1474  16.110   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 2103  on 1519  degrees of freedom
Residual deviance: 1575  on 1516  degrees of freedom
AIC: 1583

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>This confirms that all three variables are independently associated with the outcome.</p>
<p>As we previously highlighted the interaction with HIV status, let’s add that to the model…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>final_2var_model_int <span class="ot">&lt;-</span> <span class="fu">glm</span>(dead_or_alive <span class="sc">~</span> il_8 <span class="sc">*</span> hiv_comb <span class="sc">+</span> temp ,</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> df_wider, </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">family =</span> binomial)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">summary</span>(final_2var_model_int)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = dead_or_alive ~ il_8 * hiv_comb + temp, family = binomial, 
    data = df_wider)

Coefficients:
                          Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)               -93.8962     5.9942  -15.66   &lt;2e-16 ***
il_8                        4.0508     0.3193   12.69   &lt;2e-16 ***
hiv_combHIV_Positive        4.5424     0.3975   11.43   &lt;2e-16 ***
temp                        2.3878     0.1586   15.06   &lt;2e-16 ***
il_8:hiv_combHIV_Positive  -4.0720     0.3530  -11.53   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 2103.0  on 1519  degrees of freedom
Residual deviance: 1384.7  on 1515  degrees of freedom
AIC: 1394.7

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>Here, the lower AIC value in the interaction model (1394 <em>cf.</em> 1583) suggests a better fit. We can then use the predictions of this model to inform a ROC analysis.</p>
</section>
<section id="roc-analysis-of-boruta-rfe-parsimony-model" class="level4" data-number="17.9.4.5">
<h4 data-number="17.9.4.5" class="anchored" data-anchor-id="roc-analysis-of-boruta-rfe-parsimony-model"><span class="header-section-number">17.9.4.5</span> ROC Analysis of Boruta + RFE parsimony model</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add model predictions if not already done</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>df_wider<span class="sc">$</span>glm_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(final_2var_model, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>df_wider<span class="sc">$</span>glm_prob_int <span class="ot">&lt;-</span> <span class="fu">predict</span>(final_2var_model_int, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot IL-8 alone</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ROCit_plot</span>(<span class="at">data =</span> df_wider, <span class="at">score_col =</span> <span class="st">"il_8"</span>, <span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>, <span class="at">color =</span> <span class="st">"#000000"</span>) <span class="sc">+</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"IL-8 Alone"</span>)</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot full logistic model</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ROCit_plot</span>(<span class="at">data =</span> df_wider, <span class="at">score_col =</span> <span class="st">"glm_prob"</span>, <span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>, <span class="at">color =</span> <span class="st">"#0072B2"</span>) <span class="sc">+</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"IL-8 + HIV + Temp"</span>)</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot full logistic model</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ROCit_plot</span>(<span class="at">data =</span> df_wider, <span class="at">score_col =</span> <span class="st">"glm_prob_int"</span>, <span class="at">class_col =</span> <span class="st">"dead_or_alive"</span>, <span class="at">color =</span> <span class="st">"#0072B2"</span>) <span class="sc">+</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"IL-8 * HIV +  Temp"</span>)</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine using patchwork</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Analysis_02_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
<p>These side-by-side ROC plots make the contrast very clear:</p>
<ul>
<li><p><strong>IL-8 alone</strong> achieves an AUC of <strong>0.69 (0.66–0.71)</strong> — modest discrimination.</p></li>
<li><p><strong>IL-8 + HIV + Temp</strong> reaches an AUC of <strong>0.82 (0.80–0.84)</strong> — very good discrimination.</p></li>
<li><p><strong>IL-8 * HIV + Temp</strong> reaches an AUC of <strong>0.86 (0.84–0.88)</strong> — excellent discrimination</p></li>
</ul>
<p>This demonstrates that:</p>
<ul>
<li><p>IL-8 is informative, but insufficient alone.</p></li>
<li><p>Simple clinical and demographic factors like <strong>temperature</strong> and <strong>HIV status</strong> dramatically enhance predictive performance and these can be parsimoniously identified through Boruta and RFE.</p></li>
</ul>
</section>
</section>
</section>
<section id="summary" class="level1" data-number="18">
<h1 data-number="18"><span class="header-section-number">18</span> Summary</h1>
<p>This analysis walks through a <strong>complete pipeline for biomarker evaluation</strong>, simulating what a robust approach might look like in real-world clinical research. It highlights best practices for handling, transforming, selecting, and modelling data — even though the data used here are synthetic.</p>
<hr>
<section id="data-import-pre-processing" class="level4" data-number="18.0.0.1">
<h4 data-number="18.0.0.1" class="anchored" data-anchor-id="data-import-pre-processing"><span class="header-section-number">18.0.0.1</span> <strong>1. Data Import &amp; Pre-processing</strong></h4>
<ul>
<li><p><strong>Raw data</strong> representing biomarker values from assay plates (e.g., ELISA or multiplex formats) were loaded.</p></li>
<li><p>Basic <strong>tidying</strong> included reshaping into wide format, handling missing data, and correcting formatting inconsistencies.</p></li>
<li><p><strong>Z-score normalisation</strong> was applied to place all markers on a common scale, controlling for magnitude differences across assays.</p></li>
</ul>
<hr>
</section>
<section id="initial-outcome-assessment" class="level4" data-number="18.0.0.2">
<h4 data-number="18.0.0.2" class="anchored" data-anchor-id="initial-outcome-assessment"><span class="header-section-number">18.0.0.2</span> <strong>2. Initial Outcome Assessment</strong></h4>
<ul>
<li><p><strong>Univariate ROC curves</strong> were plotted for individual biomarkers (e.g., IL-8) to evaluate crude discriminatory power.</p></li>
<li><p>Metrics like <strong>AUC</strong>, <strong>positive predictive value (PPV)</strong>, and <strong>logistic regression coefficients</strong> were calculated to get early performance estimates.</p></li>
<li><p>A key point here: <em>PPV or NPV are especially important in clinical decision-making where ruling in, or ruling-out disease can sometimes matter more than balanced accuracy.</em></p></li>
</ul>
<hr>
</section>
<section id="multivariate-feature-profiling" class="level4" data-number="18.0.0.3">
<h4 data-number="18.0.0.3" class="anchored" data-anchor-id="multivariate-feature-profiling"><span class="header-section-number">18.0.0.3</span> <strong>3. Multivariate Feature Profiling</strong></h4>
<ul>
<li><p><strong>Principal Component Analysis (PCA)</strong> was used to explore latent structure across all biomarkers:</p>
<ul>
<li><p>Identified major axes of variation.</p></li>
<li><p>Helped visualise the relative spread of ‘Dead’ vs ‘Alive’ profiles.</p></li>
</ul></li>
<li><p><strong>Mahalanobis distance</strong> from control centroids was calculated to summarise overall biomarker deviation, capturing <strong>multivariate ‘anomaly’ signals</strong>.</p></li>
</ul>
<hr>
</section>
<section id="adding-clinical-covariates" class="level4" data-number="18.0.0.4">
<h4 data-number="18.0.0.4" class="anchored" data-anchor-id="adding-clinical-covariates"><span class="header-section-number">18.0.0.4</span> <strong>4. Adding Clinical Covariates</strong></h4>
<ul>
<li><p>Demographic and physiological variables (e.g., age, sex, temperature, respiratory rate) were added to mirror real clinical settings.</p></li>
<li><p>These included both continuous and categorical variables, showing the need for <strong>flexible models</strong> that accommodate mixed data types.</p></li>
</ul>
<hr>
</section>
<section id="feature-selection-via-boruta" class="level4" data-number="18.0.0.5">
<h4 data-number="18.0.0.5" class="anchored" data-anchor-id="feature-selection-via-boruta"><span class="header-section-number">18.0.0.5</span> <strong>5. Feature Selection via Boruta</strong></h4>
<ul>
<li><p>The <strong>Boruta algorithm</strong> selected all relevant features using a robust wrapper method with a random forest backend.</p></li>
<li><p>Tentative variables were resolved using <strong>median-based rough fixing</strong>, and variable importance was visualised clearly.</p></li>
<li><p>The process retained both biomarkers and clinical indicators, showing that <strong>value can emerge from either domain</strong>.</p></li>
</ul>
<hr>
</section>
<section id="feature-reduction-with-rfe" class="level4" data-number="18.0.0.6">
<h4 data-number="18.0.0.6" class="anchored" data-anchor-id="feature-reduction-with-rfe"><span class="header-section-number">18.0.0.6</span> <strong>6. Feature Reduction with RFE</strong></h4>
<ul>
<li><p><strong>Recursive Feature Elimination (RFE)</strong> was applied to the confirmed Boruta variables.</p></li>
<li><p>Through cross-validation, we identified a <strong>parsimonious 3-variable model</strong> (IL-8, HIV status, temperature) that achieved nearly optimal performance.</p></li>
<li><p>This step is critical in preventing <strong>overfitting</strong> and improving model portability.</p></li>
</ul>
<hr>
</section>
<section id="multivariate-model-building-roc-evaluation" class="level4" data-number="18.0.0.7">
<h4 data-number="18.0.0.7" class="anchored" data-anchor-id="multivariate-model-building-roc-evaluation"><span class="header-section-number">18.0.0.7</span> <strong>7. Multivariate Model Building &amp; ROC Evaluation</strong></h4>
<ul>
<li><p>A logistic regression model using the top 3 features was fit and compared to IL-8 alone:</p>
<ul>
<li><p><strong>AUC improved from 0.70 to 0.88</strong>,</p></li>
<li><p>Showcasing the power of <strong>multi-dimensional predictive signatures</strong> over single markers.</p></li>
</ul></li>
<li><p>ROC curves were visualised side-by-side to reinforce this.</p></li>
</ul>
<hr>
</section>
<section id="final-reflection" class="level3" data-number="18.0.1">
<h3 data-number="18.0.1" class="anchored" data-anchor-id="final-reflection"><span class="header-section-number">18.0.1</span> Final Reflection</h3>
<p>This approach exemplifies a <strong>best-practice pipeline</strong> for evaluating candidate biomarkers in biomedical research:</p>
<ul>
<li><p>It starts with <strong>rigorous data preparation</strong>,</p></li>
<li><p>Progresses through <strong>exploratory analysis</strong>, <strong>feature selection</strong>, and <strong>cross-validated modelling</strong>,</p></li>
<li><p>And ends with <strong>performance evaluation</strong> tailored to clinical relevance.</p></li>
</ul>
<p>While simulated, this end-to-end workflow mirrors the decisions, trade-offs, and methods required in real-world biomarker discovery and translational modelling.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Specimen_Testing.html" class="pagination-link" aria-label="Specimen Testing">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Specimen Testing</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./appendix.html" class="pagination-link" aria-label="Funding &amp; Declarations">
        <span class="nav-page-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Funding &amp; Declarations</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>